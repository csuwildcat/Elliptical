!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var s=t();for(var r in s)("object"==typeof exports?exports:e)[r]=s[r]}}(window,function(){return function(e){var t={};function s(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(r,i,function(t){return e[t]}.bind(null,i));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=7)}([function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(3),i=s(4);t.blankTableDefinition={id:"",count:0,name:"",rowLocks:{},model:{},columns:[],indexes:{},actions:[],queries:{},views:[],pkType:"string",pkCol:[],isPkNum:!1,ai:!1},t.binarySearch=(e,s,r,i,a)=>{const n=i||0,o=a||e.length;if(e[n]>=s)return r?-1:n;if(e[o]<=s)return r?-1:o+1;const h=Math.floor((n+o)/2);return s==e[h]?h:o-1==n?r?-1:o:s>e[h]?t.binarySearch(e,s,r,h,o):s<e[h]?t.binarySearch(e,s,r,n,h):r?-1:o},t.titleCase=e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase(),t.slugify=e=>String(e).replace(/\s+/g,"-").replace(/[^0-9a-z\-]/gi,"").toLowerCase(),t.buildQuery=(e,s,r,i)=>({databaseID:e,table:r||s.selectedTable,parent:s,action:i,state:"pending",result:[],time:Date.now(),queryID:t.fastID(),extend:[],comments:[],tags:[]}),t.keyToDate=(e,t,s)=>s&&"date"===t?Date.parse(s):s,t.adapterFilters=(e,s,r)=>({write:(i,a,n,o,h)=>{e&&(a=t.keyToDate(s,s.getDB(e)._tables[i].pkType,a),s.doFilter(e,"adapterWrite",{res:{table:i,pk:a,row:n,complete:o,error:h},query:r},t=>{if(!t)return;if(r&&r.transactionId)return s.txs[r.transactionId].push({table:i,type:"put",data:t.res.row}),void t.res.complete(null);(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).write(s.getDB(e)._tableIds[t.res.table],t.res.pk,t.res.row,e=>{t.res.complete(e)},t.res.error)},h))},read:(i,a,n,o)=>{e&&(a=t.keyToDate(s,s.getDB(e)._tables[i].pkType,a),s.doFilter(e,"adapterRead",{res:{table:i,pk:a,complete:n,error:o},query:r},r=>{if(!r)return;(s.getDB(e)._tables[r.res.table].mode||s.getDB(e).adapter).read(s.getDB(e)._tableIds[r.res.table],r.res.pk,i=>{if(i)if("date"===s.getDB(e)._tables[r.res.table].pkType){const a=Object.assign({},i);t.deepSet(s.getDB(e)._tables[r.res.table].pkCol,a,new Date(r.res.pk).toISOString()),r.res.complete(a)}else r.res.complete(i);else r.res.complete(void 0)},r.res.error)},o))},readMulti:(i,a,n,o,h,l,d,c)=>{e&&(n=t.keyToDate(s,s.getDB(e)._tables[i].pkType,n),o=t.keyToDate(s,s.getDB(e)._tables[i].pkType,o),s.doFilter(e,"adapterReadMulti",{res:{table:i,type:a,offsetOrLow:n,limitOrHigh:o,reverse:h,onRow:l,complete:d,error:c},query:r},r=>{if(!r)return;(s.getDB(e)._tables[r.res.table].mode||s.getDB(e).adapter).readMulti(s.getDB(e)._tableIds[r.res.table],r.res.type,r.res.offsetOrLow,r.res.limitOrHigh,r.res.reverse,(i,a)=>{if("date"===s.getDB(e)._tables[r.res.table].pkType){const n=Object.assign({},i),o=t.deepGet(s.getDB(e)._tables[r.res.table].pkCol,n);t.deepSet(s.getDB(e)._tables[r.res.table].pkCol,n,new Date(o).toISOString()),r.res.onRow(n,a)}else r.res.onRow(i,a)},()=>{r.res.complete()},r.res.error)},c))},connect:(t,i,a)=>{e&&s.doFilter(e,"adapterConnect",{res:{id:t,complete:i,error:a},query:r},t=>{t&&s.getDB(e).adapter.connect(t.res.id,t.res.complete,t.res.error)},a)},disconnect:(t,i)=>{e&&s.doFilter(e,"adapterDisconnect",{res:{complete:t,error:i},query:r},t=>{t&&s.getDB(e).adapter.disconnect(t.res.complete,t.res.error)},i)},createTable:(t,i,a,n)=>{e&&s.doFilter(e,"adapterCreateTable",{res:{table:t,tableData:i,complete:a,error:n},query:r},t=>{if(!t)return;(i.mode||s.getDB(e).adapter).createTable(s.getDB(e)._tableIds[t.res.table],t.res.tableData,t.res.complete,t.res.error)},n)},dropTable:(t,i,a)=>{e&&s.doFilter(e,"adapterDropTable",{res:{table:t,complete:i,error:a},query:r},t=>{if(!t)return;(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).dropTable(s.getDB(e)._tableIds[t.res.table],t.res.complete,t.res.error)},a)},delete:(i,a,n,o)=>{e&&(a=t.keyToDate(s,s.getDB(e)._tables[i].pkType,a),s.doFilter(e,"adapterDelete",{res:{table:i,pk:a,complete:n,error:o},query:r},t=>{if(!t)return;if(r&&r.transactionId)return s.txs[r.transactionId].push({table:i,type:"del",data:t.res.pk}),void t.res.complete();(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).delete(s.getDB(e)._tableIds[t.res.table],t.res.pk,t.res.complete,t.res.error)},o))},getTableIndex:(t,i,a)=>{e&&s.doFilter(e,"adapterGetTableIndex",{res:{table:t,complete:i,error:a},query:r},t=>{if(!t)return;(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).getTableIndex(s.getDB(e)._tableIds[t.res.table],t.res.complete,t.res.error)},a)},getTableIndexLength:(t,i,a)=>{e&&s.doFilter(e,"adapterGetTableIndexLength",{res:{table:t,complete:i,error:a},query:r},t=>{if(!t)return;(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).getTableIndexLength(s.getDB(e)._tableIds[t.res.table],t.res.complete,t.res.error)},a)},createIndex:(t,i,a,n,o)=>{e&&s.doFilter(e,"adapterCreateIndex",{res:{table:t,indexName:i,type:a,complete:n,error:o},query:r},t=>{if(!t)return;(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).createIndex(s.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.type,t.res.complete,t.res.error)},o)},deleteIndex:(t,i,a,n)=>{e&&(s.getDB(e)._tables[t].indexes[i]?s.doFilter(e,"adapterDeleteIndex",{res:{table:t,indexName:i,complete:a,error:n},query:r},t=>{if(!t)return;(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).deleteIndex(s.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.complete,t.res.error)},n):n({error:`Index ${i} not found!`}))},addIndexValue:(i,a,n,o,h,l)=>{if(!e)return;if(!s.getDB(e)._tables[i].indexes[a])return void l({error:`Index ${a} not found!`});let d=void 0===o||"undefined"===o?"__NULL__":o;"number"==typeof d&&s.getDB(e)._tables[i].indexes[a].props&&s.getDB(e)._tables[i].indexes[a].props.offset&&(d+=s.getDB(e)._tables[i].indexes[a].props.offset||0),s.getDB(e)._tables[i].indexes[a].props&&s.getDB(e)._tables[i].indexes[a].props.ignore_case&&(d=String(d||"").toUpperCase()),d=t.keyToDate(s,s.getDB(e)._tables[i].indexes[a].isDate?"date":"",d),s.doFilter(e,"adapterAddIndexValue",{res:{table:i,indexName:a,key:n,value:d,complete:h,error:l},query:r},t=>{if(!t)return;if(r&&r.transactionId)return s.txs[r.transactionId].push({table:i,type:"idx-put",data:{indexName:t.res.indexName,tableId:s.getDB(e)._tableIds[t.res.table],key:t.res.key,value:t.res.value}}),void t.res.complete();(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).addIndexValue(s.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.key,t.res.value,t.res.complete,t.res.error)},l)},deleteIndexValue:(i,a,n,o,h,l)=>{if(!e)return;if(!s.getDB(e)._tables[i].indexes[a])return void l({error:`Index ${a} not found!`});let d=void 0===o||"undefined"===o?"__NULL__":o;"number"==typeof d&&s.getDB(e)._tables[i].indexes[a].props&&s.getDB(e)._tables[i].indexes[a].props.offset&&(d+=s.getDB(e)._tables[i].indexes[a].props.offset||0),s.getDB(e)._tables[i].indexes[a].props&&s.getDB(e)._tables[i].indexes[a].props.ignore_case&&(d=String(d||"").toUpperCase()),d=t.keyToDate(s,s.getDB(e)._tables[i].indexes[a].isDate?"date":"",d),s.doFilter(e,"adapterDeleteIndexValue",{res:{table:i,indexName:a,key:n,value:d,complete:h,error:l},query:r},t=>{if(!t)return;if(r&&r.transactionId)return s.txs[r.transactionId].push({table:i,type:"idx-del",data:{indexName:t.res.indexName,tableId:s.getDB(e)._tableIds[t.res.table],key:t.res.key,value:t.res.value}}),void t.res.complete();(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).deleteIndexValue(s.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.key,t.res.value,t.res.complete,t.res.error)},l)},readIndexKey:(i,a,n,o,h,l)=>{if(!e)return;if(!s.getDB(e)._tables[i].indexes[a])return void l({error:`Index ${a} not found!`});let d="NULL"===n?"__NULL__":n;"number"==typeof d&&s.getDB(e)._tables[i].indexes[a].props&&s.getDB(e)._tables[i].indexes[a].props.offset&&(d+=s.getDB(e)._tables[i].indexes[a].props.offset||0),d=t.keyToDate(s,s.getDB(e)._tables[i].indexes[a].isDate?"date":"",d),s.getDB(e)._tables[i].indexes[a].props&&s.getDB(e)._tables[i].indexes[a].props.ignore_case&&(d=String(d||"").toUpperCase()),s.doFilter(e,"adapterReadIndexKey",{res:{table:i,indexName:a,pk:d,onRowPK:o,complete:h,error:l},query:r},t=>{if(!t)return;(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).readIndexKey(s.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.pk,t.res.onRowPK,t.res.complete,t.res.error)},l)},readIndexKeys:(i,a,n,o,h,l,d,c,u)=>{if(!e)return;let p=o,y=h;s.getDB(e)._tables[i].indexes[a]?("number"==typeof p&&"number"==typeof y&&"range"===n&&s.getDB(e)._tables[i].indexes[a]&&s.getDB(e)._tables[i].indexes[a].props.offset&&(p+=s.getDB(e)._tables[i].indexes[a].props.offset||0,y+=s.getDB(e)._tables[i].indexes[a].props.offset||0),p=t.keyToDate(s,s.getDB(e)._tables[i].indexes[a].isDate?"date":"",p),y=t.keyToDate(s,s.getDB(e)._tables[i].indexes[a].isDate?"date":"",y),"range"===n&&s.getDB(e)._tables[i].indexes[a].props&&s.getDB(e)._tables[i].indexes[a].props.ignore_case&&(p=String(p||"").toUpperCase(),y=String(y||"").toUpperCase()),s.doFilter(e,"adapterReadIndexKeys",{res:{table:i,indexName:a,type:n,offsetOrLow:p,limitOrHigh:y,reverse:l,onRowPK:d,complete:c,error:u},query:r},t=>{if(!t)return;(s.getDB(e)._tables[t.res.table].mode||s.getDB(e).adapter).readIndexKeys(s.getDB(e)._tableIds[t.res.table],t.res.indexName,t.res.type,t.res.offsetOrLow,t.res.limitOrHigh,t.res.reverse,(e,s)=>{"__NULL__"!==e&&t.res.onRowPK(e,s)},t.res.complete,t.res.error)},u)):u({error:`Index ${a} not found!`})}}),t.maybeDate=e=>{const t=Date.parse(e);return isNaN(t)?e:t},t.mutateRowTypes=(e,t,s,r)=>{if(!e)return t;const i=r.getDB(e),a=r.getDB(e)._tables[s];if(!a)throw new Error(`nSQL: Table "${s}" not found!`);const n=i.config.types||{},o=(e,t,s)=>t?s&&s.length&&-1!==s.indexOf("[]")?Array.isArray(t)?t.map(t=>o(e,t,s.slice(0,s.lastIndexOf("[]")))):[]:(e.forEach(e=>{if(e.model)t[e.key]=o(e.model,void 0!==t?t[e.key]:void 0);else{const s=e.type.replace(/\[\]/gim,""),r=n[s];if(r&&r.onSelect)t[e.key]=r.onSelect(t[e.key]);else switch(e.type){case"date":t[e.key]=new Date(t[e.key]).toISOString()}}}),t):t,h=a.select?a.select(t):t;return o(r.getDB(e)._tables[s].columns,h)},t.noop=()=>{},t.throwErr=e=>{throw new Error(e)},t.nan=e=>isNaN(e)||null===e?0:parseFloat(e),t.assign=e=>e?JSON.parse(JSON.stringify(e)):e,t.objectsEqual=(e,t)=>e===t||"object"==typeof e&&(!(!e||!t)&&i(e,t));t._nanoSQLQueue=class{constructor(e,t,s){this.processItem=e,this.onError=t,this.onComplete=s,this._items=[],this._going=!1,this._done=!1,this._count=0,this._triggeredComplete=!1,this._progressBuffer=this._progressBuffer.bind(this)}_progressBuffer(){if(this._triggeredComplete)return;if(this._done&&!this._items.length)return this._triggeredComplete=!0,void(this.onComplete&&this.onComplete());if(!this._items.length)return void(this._going=!1);const e=()=>{this._count++,this._count%100==0?t.setFast(this._progressBuffer):this._progressBuffer()},s=this._items.shift()||[];s[1]?s[1](s[0],e,this.onError?this.onError:t.noop):this.processItem&&this.processItem(s[0],this._count,e,this.onError?this.onError:t.noop)}finished(){this._done=!0,this._triggeredComplete||this._going||this._items.length||(this._triggeredComplete=!0,this.onComplete&&this.onComplete())}newItem(e,t){this._items.push([e,t]),this._going||(this._going=!0,this._progressBuffer())}},t.chainAsync=(e,s)=>new Promise((r,i)=>{if(!e||!e.length)return void r([]);let a=[],n=0;const o=()=>{n<e.length?s(e[n],n,e=>{a.push(e||0),++n%250==0?t.setFast(()=>{o()}):o()},e=>{i(e)}):r(a)};o()}),t.allAsync=(e,t)=>e&&e.length?Promise.all((e||[]).map((e,s)=>new Promise((r,i)=>{t(e,s,r,i)}))):Promise.resolve([]);const a="undefined"==typeof window?"":navigator.userAgent||"";t.isSafari=0!==a.length&&(/^((?!chrome|android).)*safari/i.test(a)||/iPad|iPhone|iPod/.test(a)&&!window.MSStream),t.isMSBrowser=0!==a.length&&(a.indexOf("MSIE ")>0||a.indexOf("Trident/")>0||a.indexOf("Edge/")>0),t.isAndroid=/Android/.test(a),t.random16Bits=()=>{if("undefined"==typeof crypto)return Math.round(Math.random()*Math.pow(2,16));if(crypto.getRandomValues){let e=new Uint16Array(1);return crypto.getRandomValues(e),e[0]}return"undefined"!=typeof global&&global._crypto.randomBytes?global._crypto.randomBytes(2).reduce((e,t)=>t*e):Math.round(Math.random()*Math.pow(2,16))},t.throttle=(e,t,s)=>{let r=!1;return(...i)=>{r||(r=!0,setTimeout(()=>{t.apply(e,i),r=!1},s))}},t.timeid=e=>{let s=Math.round((new Date).getTime()/(e?1:1e3)).toString();for(;s.length<(e?13:10);)s="0"+s;let r=(t.random16Bits()+t.random16Bits()).toString(16);for(;r.length<5;)r="0"+r;return s+"-"+r},t.intersect=(e,t)=>!(!e||!t)&&(!(!e.length||!t.length)&&(e||[]).filter(e=>-1!==(t||[]).indexOf(e)).length>0),t.fastID=()=>[0,0].map(e=>Math.round(1024*Math.random()).toString(16)).join(""),t.uuid=()=>{let e,s,r="";return[r,r,r,r,r,r,r,r].reduce((i,a,n)=>{for(e=t.random16Bits(),s=3===n?4:4===n?(e%16&3|8).toString(16):r,e=e.toString(16);e.length<4;)e="0"+e;return i+([2,3,4,5].indexOf(n)>-1?"-":r)+(s+e).slice(0,4)},r)},t.hash=e=>{let t=5381,s=e.length;for(;s;)t=33*t^e.charCodeAt(--s);return(t>>>0).toString(16)},t.generateID=(e,s)=>{const r={int:e=>e,date:e=>e,float:e=>e,uuid:t.uuid,timeId:()=>t.timeid(),timeIdms:()=>t.timeid(!0)};return r[e]?r[e](s||1):void 0},t.cleanArgs2=(e,s,r,i)=>{const a=(r,n,o)=>{if(-1!==r.indexOf("[]")){const e=r.slice(0,r.lastIndexOf("[]"));return Array.isArray(n)?n.map(t=>a(e,t,o)):[]}if("string"!=typeof o){let s={},r=!1,a=[];return Object.keys(o).forEach(o=>{const h=o.split(":");"*"===h[0]?r=!0:(a.push(h[0]),s[h[0]]=t.cast(e,h[1],n[h[0]],!1,i))}),r&&t.isObject(n)&&Object.keys(n).filter(e=>-1===a.indexOf(e)).forEach(e=>{s[e]=n[e]}),s}{let t=o.replace(/\[\]/gim,""),r=Object.keys(i.getDB(e).config.types||{}).reduce((s,r)=>r===t?(i.getDB(e).config.types||{})[r]:s,void 0);if(!r)throw new Error(`Can't find type ${t}!`);const h=e=>{if(-1!==e.indexOf("[]")){const t=e.slice(0,e.lastIndexOf("[]"));return Array.isArray(s)?s.map(e=>h(t)):[]}if(!r)throw new Error(`Can't find type ${t}!`);return r.model?a(o,s,r.model):n};h(o)}};return a("string"==typeof r?r:"",s,r)},t.cleanArgs=(e,s,r,i)=>{let a={},n=s.length;Object.keys(i.getDB(e).config.types||{});for(;n--;){let o=s[n].split(":");o.length>1?a[o[0]]=t.cast(e,o[1],r[o[0]]||void 0,!0,i):a[o[0]]=r[o[0]]||void 0}return a},t.isObject=e=>"[object Object]"===Object.prototype.toString.call(e),t.objSort=(e,s)=>(r,i)=>{const a=e?t.deepGet(e,r)>t.deepGet(e,i)?-1:1:r>i?-1:1;return s?-1*a:a},t.execFunction=(e,s,r,i)=>{const a=s.match(/\((.*)\)/gim);if(!a[0])return{result:void 0};const n=a[0].substr(1,a[0].length-2).split(/\,\s?(?![^\(]*\))/).map(e=>e.trim()),o=s.split("(").shift(),h=n.map(s=>{if(-1!==s.indexOf("(")){const a=t.execFunction(e,s,r,i).result;return"number"==typeof a?a:"string"==typeof a?'"'+a+'"':a}return s});return e.parent.functions[o]?e.parent.functions[o].call(e,r,i,...h):{result:void 0}},t.cast=(e,s,r,i,a)=>{if("any"===s||"blob"===s||"*"===s)return r;if(-1!==s.indexOf("[]")){const a=s.slice(0,s.lastIndexOf("[]"));return Array.isArray(r)?r.map(s=>t.cast(e,a,s,i)):[]}if(null==r)return;const n=typeof r,o={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},h=a&&e&&a.getDB(e).config.types||{};if(-1!==Object.keys(h).indexOf(s)){const n=h[s];return n.model?t.isObject(r)?Object.keys(n.model).reduce((s,n)=>{const o=n.split(":");return s[o[0]]=t.cast(e,o[1],r[o[0]],i,a),s},{}):{}:n.onSelect?n.onSelect(r):void 0}const l=(e,s)=>{switch(e){case"safestr":return l("string",s).replace(/[&<>"'`=\/]/gim,e=>o[e]);case"int":return"number"!==n||s%1!=0?Math.round(t.nan(s)):s;case"number":case"float":return"number"!==n?t.nan(s):s;case"array":return Array.isArray(s)?s:[];case"date":case"uuid":case"timeId":case"timeIdms":case"string":return"string"!==n?String(s):s;case"object":case"obj":case"map":return t.isObject(s)?s:void 0;case"boolean":case"bool":return!0===s||1===s}return i?r:null};if(null==r)return;const d=l(String(s||"").toLowerCase(),r);return void 0!==d&&-1!==["int","float","number"].indexOf(s)&&isNaN(d)?0:d},t.rad2deg=e=>180*e/Math.PI,t.deg2rad=e=>e*(Math.PI/180),t.crowDistance=(e,s,r,i,a=6371)=>{const n=t.deg2rad(r-e),o=t.deg2rad(i-s),h=Math.pow(Math.sin(n/2),2)+Math.cos(t.deg2rad(e))*Math.cos(t.deg2rad(r))*Math.pow(Math.sin(o/2),2);return a*(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)))},t.levenshtein=(e,t)=>r(e,t);const n={};t.resolvePath=e=>{if(!e)return[];if(n[e])return n[e].slice();const t=-1!==e.indexOf("[")?e.split(/\.|\[/gim).map(e=>e.replace(/\]/gim,"")):e.split(".");return n[e]=t,n[e].slice()},t.fnRegex=/^[\"|\'](.*)[\"|\']$/gim,t.getFnValue=(e,s)=>{if("number"==typeof s)return s;const r=t.fnRegex.exec(s);return r?r[1]:t.deepGet(s,e)},t.deepFreeze=e=>(Object.getOwnPropertyNames(e||{}).forEach(s=>{const r=e[s];"object"==typeof r&&null!==r&&(e[s]=t.deepFreeze(r))}),Object.freeze(e)),t.deepSet=(e,s,r)=>{const i=(e,s,a)=>{e[s+1]?(a[e[s]]&&(Array.isArray(a[e[s]])||t.isObject(a[e[s]]))||(isNaN(e[s+1])?a[e[s]]={}:a[e[s]]=[]),i(e,s+1,a[e[s]])):a[e[s]]=r};return i(Array.isArray(e)?e:t.resolvePath(e),0,s),s},t.deepGet=(e,s)=>{const r=(e,t,s)=>e[t]&&s?r(e,t+1,s[e[t]]):s;return r(Array.isArray(e)?e:t.resolvePath(e),0,s)},t.maybeAssign=e=>Object.isFrozen(e)?t.assign(e):e;const o=e=>e[0].apply(null,Array.prototype.slice.call(e,1));t.setFast="undefined"!=typeof Promise?(...e)=>{Promise.resolve().then(()=>{o(e)})}:(...e)=>{setTimeout(()=>{o(e)},0)}},function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=2.37,function(e){e[e.NONE=0]="NONE",e[e.CASCADE=1]="CASCADE",e[e.RESTRICT=2]="RESTRICT",e[e.SET_NULL=3]="SET_NULL"}(t.InanoSQLFKActions||(t.InanoSQLFKActions={})),function(e){e[e.fast=0]="fast",e[e.medium=1]="medium",e[e.slow=2]="slow",e[e.fn=3]="fn",e[e.none=4]="none"}(t.IWhereType||(t.IWhereType={}))},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(0);t.err=new Error("Memory index doesn't support this action!");t.nanoSQLMemoryIndex=class{constructor(e,t){this.assign=e,this.useCache=t}connect(e,s,r){r(t.err)}disconnect(e,s){s(t.err)}createTable(e,s,r,i){i(t.err)}dropTable(e,s,r){r(t.err)}write(e,s,r,i,a){a(t.err)}read(e,s,r,i){i(t.err)}delete(e,s,r,i){i(t.err)}readMulti(e,s,r,i,a,n,o,h){h(t.err)}getTableIndex(e,s,r){r(t.err)}getTableIndexLength(e,s,r){r(t.err)}createIndex(e,t,s,i,a){const n=`_idx_${e}_${t}`;this.createTable(n,Object.assign({},r.blankTableDefinition,{pkType:s,pkCol:["id"],isPkNum:-1!==["float","int","number"].indexOf(s)}),()=>{i()},a)}deleteIndex(e,t,s,r){const i=`_idx_${e}_${t}`;this.dropTable(i,s,r)}addIndexValue(e,t,s,i,a,n){const o=`_idx_${e}_${t}`;this.read(o,i,e=>{let t=e?e.pks:[];if(0===(t=this.assign?r.assign(t):t).length)t.push(s);else{const e=r.binarySearch(t,s,!1);t.splice(e,0,s)}this.write(o,i,{id:s,pks:this.assign?r.assign(t):t},a,n)},n)}deleteIndexValue(e,t,s,i,a,n){const o=`_idx_${e}_${t}`;this.read(o,i,e=>{let t=e?e.pks:[];if(0!==(t=this.assign?r.assign(t):t).length){{const e=t.length<100?t.indexOf(s):r.binarySearch(t,s,!0);-1!==e&&t.splice(e,1)}t.length?this.write(o,i,{id:s,pks:this.assign?r.assign(t):t},a,n):this.delete(o,i,a,n)}else a()},n)}readIndexKey(e,t,s,r,i,a){const n=`_idx_${e}_${t}`;this.read(n,s,e=>{e?(e.pks.forEach(r),i()):i()},a)}readIndexKeys(e,t,s,r,i,a,n,o,h){const l=`_idx_${e}_${t}`;this.readMulti(l,s,r,i,a,e=>{e&&e.pks.forEach(t=>{n(t,e.id)})},o,h)}}},function(e,t,s){"use strict";e.exports=function(e,t,s){var a,n,o,h,l,d,c,u;if(e===t)return 0;if(a=e.length,n=t.length,0===a)return n;if(0===n)return a;s&&(e=e.toLowerCase(),t=t.toLowerCase());c=0;for(;c<a;)i[c]=e.charCodeAt(c),r[c]=++c;u=0;for(;u<n;)for(o=t.charCodeAt(u),h=l=u++,c=-1;++c<a;)d=o===i[c]?l:l+1,l=r[c],r[c]=h=l>h?d>h?h+1:d:d>l?l+1:d;return h};var r=[],i=[]},function(e,t,s){"use strict";var r=Array.isArray,i=Object.keys,a=Object.prototype.hasOwnProperty;e.exports=function e(t,s){if(t===s)return!0;if(t&&s&&"object"==typeof t&&"object"==typeof s){var n,o,h,l=r(t),d=r(s);if(l&&d){if((o=t.length)!=s.length)return!1;for(n=o;0!=n--;)if(!e(t[n],s[n]))return!1;return!0}if(l!=d)return!1;var c=t instanceof Date,u=s instanceof Date;if(c!=u)return!1;if(c&&u)return t.getTime()==s.getTime();var p=t instanceof RegExp,y=s instanceof RegExp;if(p!=y)return!1;if(p&&y)return t.toString()==s.toString();var g=i(t);if((o=g.length)!==i(s).length)return!1;for(n=o;0!=n--;)if(!a.call(s,g[n]))return!1;for(n=o;0!=n--;)if(!e(t[h=g[n]],s[h]))return!1;return!0}return t!=t&&s!=s}},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(6),i=s(12),a=s(13);let n;"undefined"!=typeof global&&(n=global._snapAdapter),t.detectStorage=()=>"undefined"==typeof window?(console.warn("RocksDB has been removed in default nanoSQL!  Follow this guide to restore RocksDB databases: https://nanosql.io/migration.html#_2-3-1-2-3-2"),"SNP"):"undefined"!=typeof indexedDB?"IDB":void 0!==window.openDatabase?"WSQL":"LS",t.resolveMode=(e,s)=>{if("string"!=typeof e)return e;switch("PERM"===e&&(e=t.detectStorage()),e){case"TEMP":return new r.SyncStorage(!1);case"LS":return new r.SyncStorage(!0);case"WSQL":return new i.WebSQL(s&&s.size);case"IDB":return new a.IndexedDB(s&&s.version);case"RKS":throw new Error("RocksDB is no longer built in!  Grab it here https://www.npmjs.com/package/@nano-sql/adapter-rocksdb");case"LVL":throw new Error("LevelDB is no longer build in!  Grab it here https://www.npmjs.com/package/@nano-sql/adapter-leveldb");case"SNP":return new n;default:throw new Error(`Cannot find mode ${e}!`)}}},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(1),i=s(0),a=s(2);t.SyncStorage=class extends a.nanoSQLMemoryIndex{constructor(e){super(!0,!1),this.useLS=e,this.plugin={name:"Sync Storage Adapter",version:r.VERSION},this._index={},this._rows={},this._ai={},this._tableConfigs={}}connect(e,t,s){this._id=e,t()}createTable(e,t,s,r){if(this._index[e]=[],this._rows[e]={},this._tableConfigs[e]=t,this.useLS){const t=localStorage.getItem(this._id+"->"+e+"_idx");t&&(this._index[e]=JSON.parse(t),this._ai[e]=parseFloat(localStorage.getItem(this._id+"->"+e+"_ai")||"0"))}s()}dropTable(e,t,s){this._index[e].forEach(t=>{this.useLS?localStorage.removeItem(this._id+"->"+e+"__"+t):delete this._rows[e][t]}),this.useLS&&localStorage.removeItem(this._id+"->"+e+"_idx"),delete this._index[e],delete this._rows[e],t()}disconnect(e,t){e()}write(e,t,s,r,a){if(void 0!==(t=t||i.generateID(this._tableConfigs[e].pkType,this._ai[e]+1))){if(this._tableConfigs[e].ai&&(this._ai[e]=Math.max(this._ai[e]||0,t)),-1===this._index[e].indexOf(t)){if(this._ai[e])this._index[e].push(t);else{const s=i.binarySearch(this._index[e],t,!1);this._index[e].splice(s,0,t)}this.useLS&&(localStorage.setItem(this._id+"->"+e+"_idx",JSON.stringify(this._index[e])),localStorage.setItem(this._id+"->"+e+"_ai",String(this._ai[e])))}i.deepSet(this._tableConfigs[e].pkCol,s,t),this.useLS?(localStorage.setItem(this._id+"->"+e+"__"+t,JSON.stringify(s)),r(t)):(this._rows[e][t]=i.deepFreeze(s),r(t))}else a(new Error("Can't add a row without a primary key!"))}read(e,t,s,r){if(this.useLS){const r=localStorage.getItem(this._id+"->"+e+"__"+t);s(r?JSON.parse(r):void 0)}else s(this._rows[e][t])}delete(e,t,s,r){let i=this._index[e].indexOf(t);-1!==i&&(this._index[e].splice(i,1),this.useLS&&localStorage.setItem(this._id+"->"+e+"_idx",JSON.stringify(this._index[e].keys()))),this.useLS?localStorage.removeItem(this._id+"->"+e+"__"+t):delete this._rows[e][t],s()}readMulti(e,t,s,r,a,n,o,h){let l={range:[s,r],offset:[s,s+r],all:[]}[t];const d=(()=>{switch(t){case"all":return this._index[e].slice();case"offset":const s=this._index[e].length-1;return a?this._index[e].slice(s-l[1],s-l[0]):this._index[e].slice(l[0],l[1]);case"range":let r=i.binarySearch(this._index[e],l[0],!1),n=i.binarySearch(this._index[e],l[1],!1);for(;this._index[e][n]>l[1];)n--;for(;this._index[e][r]<l[0];)r++;return this._index[e].slice(r,n+1)}return[]})();a&&d.reverse(),d.forEach((t,s)=>{this.useLS?n(JSON.parse(localStorage.getItem(this._id+"->"+e+"__"+t)||"{}"),s):n(this._rows[e][t],s)}),o()}getTableIndex(e,t,s){t(this._index[e].slice())}getTableIndexLength(e,t,s){t(this._index[e].length)}}},function(e,t,s){e.exports=s(8)},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(9),i=s(0),a=s(1);t.InanoSQLInstance=a.InanoSQLInstance;const n=s(10),o=s(11),h=s(14),l=s(0),d=s(5),c=s(6);class u{constructor(){this.dbs={},this.selectedDB="nSQL_DB",this.version=a.VERSION,this.events={},this.planetRadius=6371,this.txs={},this._countTimers={};const e=e=>"object"==typeof e?JSON.stringify(e):String(e),t=e=>t=>isNaN(t)||null===t?0:e(t);this.indexTypes={string:e,geo:e=>{},float:t(parseFloat),int:t(parseInt),number:t(parseFloat),date:t(parseInt),uuid:e,timeId:e,timeIdms:e},this._checkTTL=this._checkTTL.bind(this),n.attachDefaultFns(this)}getDB(e){const t=e||this.selectedDB;if(!this.dbs[t])throw new Error(`Database ${t} doesn't exist!`);return this.dbs[t]}_rebuildFKs(){this.getDB().state.cacheId=i.uuid(),this.getDB()._fkRels={},Object.keys(this.getDB()._tables).forEach(e=>{const t=this.getDB()._tables[e];Object.keys(t.indexes).forEach(s=>{const r=t.indexes[s];if(r.props&&r.props.foreignKey){const t=i.resolvePath(r.props.foreignKey.target),n=t.shift();this.getDB()._fkRels[n]||(this.getDB()._fkRels[n]=[]),this.getDB()._fkRels[n].push({selfPath:t.map(e=>e.replace(/\[\]/gim,"")),selfIsArray:-1!==r.props.foreignKey.target.indexOf("[]"),childTable:e,childPath:r.path,childIsArray:r.isArray,childIndex:s,onDelete:r.props.foreignKey.onDelete||a.InanoSQLFKActions.NONE})}})})}doFilter(e,t,s,r,a){e&&this.dbs[e]&&this.getDB(e).filters[t]?i.chainAsync(this.getDB(e).filters[t],(r,i,n)=>{this.getDB(e).filters[t][i](s,e=>{s=e,n()},a)}).then(()=>{r(s)}):r(s)}getCache(e,t){if(!this.getDB()._queryCache[e])throw new Error(`Cache "${e}" not found!`);return t?this.getDB()._queryCache[e].slice(t.offset,t.offset+t.limit):this.getDB()._queryCache[e].slice()}clearCache(e){const t=void 0!==this.getDB()._queryCache[e];return delete this.getDB()._queryCache[e],t}clearTTL(e){const t=this.selectedTable+"."+e;return new Promise((e,s)=>{this.triggerQuery(this.selectedDB,Object.assign({},i.buildQuery(this.selectedDB,this,"_ttl","delete"),{where:["key","=",t]}),i.noop,e,s)})}expires(e){return new Promise((t,s)=>{const r=this.selectedTable+"."+e;let a=[];this.triggerQuery(this.selectedDB,Object.assign({},i.buildQuery(this.selectedDB,this,"_ttl","select"),{where:["key","=",r]}),e=>{a.push(e)},()=>{a.length?t({time:(a[0].date-Date.now())/1e3,cols:a[0].cols}):t({time:-1,cols:[]})},s)})}_checkTTL(){if(this.getDB().config.disableTTL)return;this.getDB()._ttlTimer&&clearTimeout(this.getDB()._ttlTimer);let e=0,t=0;const s=()=>{let r=[];this.triggerQuery(this.selectedDB,Object.assign({},i.buildQuery(this.selectedDB,this,"_ttl","select"),{limit:20,offset:20*e}),e=>{r.push(e)},()=>{r.length?i.chainAsync(r,(e,s,r)=>{if(e.date<Date.now()){const t=()=>{this.triggerQuery(this.selectedDB,Object.assign({},i.buildQuery(this.selectedDB,this,"_ttl","delete"),{where:["key","=",e.key]}),i.noop,r,i.throwErr)},s=e.key.split("."),a=s[0],n=-1===["float","int","number"].indexOf(this.getDB()._tables[a].pkType)?s[1]:parseFloat(s[1]);if(e.cols.length){let s={};e.cols.forEach(e=>{s[e]=null}),this.triggerQuery(this.selectedDB,Object.assign({},i.buildQuery(this.selectedDB,this,a,"upsert"),{actionArgs:s,where:[this.getDB()._tables[a].pkCol,"=",n]}),i.noop,t,i.throwErr)}else this.triggerQuery(this.selectedDB,Object.assign({},i.buildQuery(this.selectedDB,this,a,"delete"),{where:[this.getDB()._tables[a].pkCol,"=",n]}),i.noop,t,i.throwErr)}else t=Math.max(t,e.date),r()}).then(()=>{e++,s()}):t&&(this.getDB()._ttlTimer=setTimeout(this._checkTTL,t-Date.now()))},i.throwErr)};s()}selectTable(e){return e&&(this.selectedTable=e),this}getPeers(){return JSON.parse(localStorage.getItem("nsql-peers-"+this.getDB().state.id)||"[]")}_initPlugins(e){return new Promise((t,s)=>{let r={};(e.plugins||[]).forEach(e=>{(e.filters||[]).forEach(e=>{r[e.name]||(r[e.name]=[]);let t=e.priority;for(;r[e.name][t];)t++;r[e.name][t]=e.call})}),Object.keys(r).forEach(e=>{this.getDB().filters[e]=[],r[e].forEach(t=>{t&&this.getDB().filters[e].unshift(t)})});const i=(e,t)=>!t||!t.length||(1===t.length?e>=t[0]:e>=t[0]&&e<t[1]);let n=!1;(e.plugins||[]).forEach(t=>{if(t.dependencies){const r=t.dependencies||{};Object.keys(t.dependencies).forEach((o,h,l)=>{if("core"===o)i(a.VERSION,r[o])||(n=!0,s(`Plugin "${t.name}" requires a different core version of nano-sql!`));else{const a=(e.plugins||[]).reduce((e,t)=>t.name===o?t:e);a||(n=!0,s(`Plugin "${t.name}" requires plugin "${o}" but it isn't installed!`)),i(a.version,r[o])||(n=!0,s(`Plugin "${t.name}" requires a different version of "${o}"!`))}})}}),n||t()})}_saveTableIds(e){return new Promise((t,s)=>{this.triggerQuery(e,Object.assign({},i.buildQuery(e,this,"_util","upsert"),{actionArgs:i.assign({key:"tableIds",value:this.getDB(e)._tableIds})}),i.noop,t,s)})}presetQuery(e,t){if("string"!=typeof this.selectedTable)throw new Error("Can't get table queries without selecting a table!");if(!(-1!==Object.keys(this.getDB()._tables[this.selectedTable].queries).indexOf(e)))throw new Error(`Can't find preset query ${e}!`);const s=this.getDB()._tables[this.selectedTable].queries[e].args;let r={};s&&(r=i.cleanArgs2(this.selectedDB,t,s,this));const a=this.getDB()._tables[this.selectedTable].queries[e].call(this,r),n=this.query("");return n._query=a,n}useDatabase(e){return this.selectedDB=e,this}createDatabase(e){return this.connect(e)}listDatabases(){return Object.keys(this.dbs)}dropDatabase(e){return new Promise((t,s)=>{const r=Object.keys(this.getDB(e)._tables);i.chainAsync(r,(t,s,r,a)=>{const n=this.getDB(e)._tables[t];this.triggerQuery(e,Object.assign({},i.buildQuery(e,this,n.name,"drop")),i.noop,()=>{r()},a)}).then(()=>{delete this.dbs[e],t()}).catch(s)})}maybeCreateEventObject(e){this.events[e]||(this.events[e]={Core:{"*":new r.ReallySmallEvents},"*":{"*":new r.ReallySmallEvents}})}connect(e={}){const t=e.id?String(e.id):"nSQL_DB";if(this.dbs[t])throw new Error(`nSQL: ${t} database has already been created!`);return this.maybeCreateEventObject(t),this.dbs[t]={adapter:new c.SyncStorage,_ttlTimer:0,_Q:new i._nanoSQLQueue,state:{activeAV:"",hasAnyEvents:!1,peers:[],pid:i.uuid(),id:i.uuid(),cacheId:i.uuid(),peerEvents:[],focused:!0,peerMode:!1,connected:!1,ready:!1,exportQueryObj:!1},config:{id:t},_tables:{},_fkRels:{},_tableIds:{_util:"_util",_ttl:"_ttl"},_queryCache:{},filters:{}},this.selectedDB=t,this._refreshEventChecker(),this._initPlugins(e).then(()=>new Promise((s,r)=>{this.doFilter(t,"config",{res:e},e=>{s(e.res)},r)})).then(e=>(this.getDB(t).state.id=t,this.getDB(t).config=Object.assign({plugins:[]},e),"undefined"!=typeof window&&e&&e.peer&&(this.getDB(t).state.peerMode=!0),new Promise((e,s)=>{this.doFilter(t,"willConnect",{res:this},()=>{e()},s)}))).then(()=>new Promise((e,s)=>{this.getDB(t).adapter=d.resolveMode(this.getDB(t).config.mode||"TEMP",this.getDB(t).config),this.getDB(t).adapter.plugin&&(this.getDB(t).config.plugins||[]).push(this.getDB(t).adapter.plugin),this._initPlugins(this.getDB(t).config).then(()=>{this.getDB(t).adapter.nSQL=this,i.adapterFilters(t,this).connect(this.getDB(t).state.id,()=>{this.doFilter(t,"postConnect",{res:this.getDB(t).config},s=>{this.getDB(t).config=s.res,e()},s)},s)}).catch(s),this.getDB(t).config.planetRadius&&(this.planetRadius=this.getDB(t).config.planetRadius)})).then(()=>{this.triggerEvent(t,{target:"Core",targetId:this.getDB(t).state.id,path:"*",events:["connect"],time:Date.now()}),this.getDB(t).state.connected=!0;const e=["_util","_ttl"].concat((this.getDB(t).config.tables||[]).map(e=>e.name));return i.chainAsync(e,(e,s,r,a)=>{switch(e){case"_util":this.triggerQuery(t,Object.assign({},i.buildQuery(t,this,"_util","create table"),{actionArgs:{name:"_util",model:{"key:string":{pk:!0},"value:any":{}},_internal:!0}}),i.noop,()=>{this.triggerQuery(t,Object.assign({},i.buildQuery(t,this,"_util","select"),{where:["key","=","tableIds"]}),e=>{this.getDB(t)._tableIds=Object.assign({},this.getDB(t)._tableIds,e.value)},()=>{r()},a)},a);break;case"_ttl":this.triggerQuery(t,Object.assign({},i.buildQuery(t,this,"_ttl","create table"),{actionArgs:{name:"_ttl",model:{"key:string":{pk:!0},"table:string":{},"cols:string[]":{},"date:number":{}},_internal:!0}}),i.noop,r,a);break;default:const s=(this.getDB(t).config.tables||[]).filter(t=>t.name===e)[0];if(!s)return void a("Table not found!");this.triggerQuery(t,Object.assign({},i.buildQuery(t,this,e,"create table"),{actionArgs:s}),i.noop,r,a)}})}).then(()=>new Promise((e,s)=>{let r;this.triggerQuery(t,Object.assign({},i.buildQuery(t,this,"_util","select"),{where:["key","=","version"]}),e=>{e&&(r=e.value)},()=>{!r||r<2?this.triggerQuery(t,Object.assign({},i.buildQuery(t,this,"_util","upsert"),{actionArgs:{key:"version",value:a.VERSION}}),i.noop,e,s):e()},s)})).then(()=>new Promise((e,s)=>{if(!this.getDB(t).config.version)return void e();let r;this.triggerQuery(t,Object.assign({},i.buildQuery(t,this,"_util","select"),{where:["key","=","db-version"]}),e=>{e&&(r=e.value)},()=>{const a=(e,s,r)=>{this.triggerQuery(t,Object.assign({},i.buildQuery(t,this,"_util","upsert"),{actionArgs:{key:"db-version",value:e}}),i.noop,s,r)};if(r){const n=()=>{if(r===this.getDB(t).config.version)a(this.getDB(t).config.version||0,e,s);else{const o=this.getDB(t).config.onVersionUpdate;if(!o)return void a(this.getDB(t).config.version||0,e,s);o(r).then(e=>{a(r=e,()=>{i.setFast(n)},s)}).catch(s)}};n()}else a(this.getDB(t).config.version||0,e,s)},s)})).then(()=>new Promise((e,s)=>{const r={target:"Core",path:"*",targetId:this.getDB(t).state.id,events:["ready"],time:Date.now()};this.doFilter(t,"ready",{res:r},s=>{this.triggerEvent(t,s.res),this.getDB(t).state.ready=!0,this.getDB(t).config.disableTTL||this._checkTTL(),this.getDB(t).config.peer&&this._initPeers(),e()},s)}))}_initPeers(){let e=0;this.getDB().state.pid=i.uuid(),this.getDB().state.peers=this.getPeers(),this.getDB().state.peers.unshift(this.getDB().state.pid),localStorage.setItem("nsql-peers-"+this.getDB().state.id,JSON.stringify(this.getDB().state.peers)),window.addEventListener("storage",t=>{if(t.key==="nsql-peers-"+this.getDB().state.id&&(this.getDB().state.peers=this.getPeers()),t.key&&0===t.key.indexOf(this.getDB().state.pid+".")){localStorage.removeItem(t.key);const e=JSON.parse(t.newValue||"{}");this.getDB().state.peerEvents.push(e.query.queryID||""),this.triggerEvent(this.selectedDB,Object.assign({},e,{types:["peer change"]})),i.setFast(()=>{this.triggerEvent(this.selectedDB,e)})}if(++e>50&&this.getDB().state.peers[0]===this.getDB().state.pid){e=0;let t=localStorage.length,s={};for(;t--;){const e=localStorage.key(t),r=e?e.match(/\w{8}-\w{4}-\w{4}-\w{4}-\w{8}/gim):null;if(e&&r){const t=(r||[""])[0];s[t]||(s[t]=[]),s[t].push(e)}}Object.keys(s).forEach(e=>{s[e].length>10&&(this.getDB().state.peers=this.getDB().state.peers.filter(t=>t!==e),s[e].forEach(e=>{localStorage.removeItem(e)}),localStorage.setItem("nsql-peers-"+this.getDB().state.id,JSON.stringify(this.getDB().state.peers)))})}}),window.onblur=()=>{this.getDB().state.focused=!1},window.onfocus=()=>{this.getDB().state.peers=this.getDB().state.peers.filter(e=>e!==this.getDB().state.pid),this.getDB().state.peers.unshift(this.getDB().state.pid),localStorage.setItem("nsql-peers-"+this.getDB().state.id,JSON.stringify(this.getDB().state.peers)),this.getDB().state.focused=!0},t.nSQL("*").on("change",e=>{const t=this.getDB().state.peerEvents.indexOf(e.query.queryID||"");-1===t?this.getDB().state.peers.filter(e=>e!==this.getDB().state.pid).forEach(t=>{localStorage.setItem(t+"."+e.query.queryID,JSON.stringify(e))}):this.getDB().state.peerEvents.splice(t,1)}),window.addEventListener("beforeunload",()=>(this.getDB().state.peers=this.getDB().state.peers.filter(e=>e!==this.getDB().state.pid),localStorage.setItem("nsql-peers-"+this.getDB().state.id,JSON.stringify(this.getDB().state.peers)),!1))}every(e){let t=0,s=[];for(;t<=e.length;)e.every?t%e.every==0&&s.push(t+(e.offset||0)):s.push(t+(e.offset||0)),t++;return s}on(e,t,s){let a=s||("string"!=typeof this.selectedTable?"":this.selectedTable);const n=this.selectedDB;this.maybeCreateEventObject(n),this.doFilter(n,"onEvent",{res:{action:e,callback:t}},t=>{switch(t.res.action){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":this.events[n].Core["*"].on(t.res.action,t.res.callback);break;case"select":case"change":case"delete":case"upsert":case"*":const s=i.resolvePath(a);this.events[n][s[0]]||(this.events[n][s[0]]={"*":new r.ReallySmallEvents});const o=s.filter((e,t)=>t>0).join(".")||"*";this.events[n][s[0]][o]||(this.events[n][s[0]][o]=new r.ReallySmallEvents),this.events[n][s[0]][o].on(t.res.action,t.res.callback);break;default:new Promise((t,s)=>{this.doFilter(n,"customEvent",{res:{nameSpace:"",path:"*"},selectedTable:a,action:e,on:!0},t,s)}).then(s=>{if(!s.res.nameSpace)throw new Error(`Invalid event "${e}"!`);this.events[n][s.res.nameSpace]||(this.events[n][s.res.nameSpace]={"*":new r.ReallySmallEvents}),this.events[n][s.res.nameSpace][s.res.path]||(this.events[n][s.res.nameSpace][s.res.path]=new r.ReallySmallEvents),this.events[n][s.res.nameSpace][s.res.path].on(t.res.action,t.res.callback),this._refreshEventChecker()})}this._refreshEventChecker()},i.noop)}off(e,t,s){let a=s||("string"!=typeof this.selectedTable?"":this.selectedTable);const n=this.selectedDB;this.maybeCreateEventObject(n),this.doFilter(n,"offEvent",{res:{action:e,callback:t}},t=>{switch(t.res.action){case"connect":case"ready":case"disconnect":case"peer change":case"slow query":this.events[n].Core["*"].off(t.res.action,t.res.callback);break;case"select":case"change":case"delete":case"upsert":case"*":const s=i.resolvePath(a);this.events[n][s[0]]||(this.events[n][s[0]]={"*":new r.ReallySmallEvents});const o=s.filter((e,t)=>t>0).join(".")||"*";this.events[n][s[0]][o]||(this.events[n][s[0]][o]=new r.ReallySmallEvents),this.events[n][s[0]][o].off(t.res.action,t.res.callback);break;default:new Promise((t,s)=>{this.doFilter(n,"customEvent",{res:{nameSpace:"",path:"*"},selectedTable:a,action:e,on:!0},t,s)}).then(s=>{if(!s.res.nameSpace)throw new Error(`Invalid event "${e}"!`);this.events[n][s.res.nameSpace]||(this.events[n][s.res.nameSpace]={"*":new r.ReallySmallEvents}),this.events[n][s.res.nameSpace][s.res.path]||(this.events[n][s.res.nameSpace][s.res.path]=new r.ReallySmallEvents),this.events[n][s.res.nameSpace][s.res.path].off(t.res.action,t.res.callback),this._refreshEventChecker()})}this._refreshEventChecker()},i.noop)}_refreshEventChecker(){return this.dbs[this.selectedDB]?(this.getDB().state.hasAnyEvents=Object.keys(this.events[this.selectedDB]).reduce((e,t)=>{if(!0===e)return!0;return Object.keys(this.events[this.selectedDB][t]).reduce((e,s)=>Object.keys(this.events[this.selectedDB][t][s].eventListeners).length+e,0)>0||e},!1),this):this}getView(e,t){return this._doAV("v",this.selectedTable,e,t)}doAction(e,t){return this._doAV("a",this.selectedTable,e,t)}_doAV(e,t,s,r){return"string"!=typeof this.selectedTable?Promise.reject("Can't do Action/View with selected table!"):new Promise((i,a)=>{this.doFilter(this.selectedDB,"actionView",{res:{AVType:e,table:t,AVName:s,AVArgs:r}},i,a)}).then(e=>{const t="a"===e.res.AVType?"actions":"views",s=this.getDB()._tables[e.res.table][t].reduce((t,s)=>s.name===e.res.AVName?s:t,null);return s?s.call(s.args?i.cleanArgs(this.selectedDB,s.args,e.res.AVArgs,this):{},this):new Promise((t,s)=>s(`${e.res.AVType} "${e.res.AVName}" Not Found!`))})}query(e,t){if(this.selectedDB&&"string"==typeof this.selectTable){const s=this.getDB().state.activeAV;return this.getDB().state.activeAV="",new h._nanoSQLQueryBuilder(this.selectedDB,this,this.selectedTable,e,t,s)}return new h._nanoSQLQueryBuilder(this.selectedDB,this,this.selectedTable,e,t,"")}triggerQuery(e,t,s,r,i){const a=t=>{new o._nanoSQLQuery(e,this,t.res,e=>{s(e)},r,i)};if("string"==typeof t.table){if(!this.getDB(e).state.connected)return void i("nSQL: Can't do a query before the database is connected!");this.doFilter(e,"query",{res:t},a,i)}else a({res:t})}triggerEvent(e,t,s){return e&&this.events[e]?(this.doFilter(e,"event",{res:t},t=>{this.getDB(e).state.hasAnyEvents&&i.setFast(()=>{t.res.events.forEach(r=>{if(s||Object.keys(this.events[e]["*"]).forEach(s=>{this.events[e]["*"][s].trigger(r,t.res)}),this.events[e][t.res.target])if("_all_"===t.res.path)Object.keys(this.events[e][t.res.target]).forEach(s=>{this.events[e][t.res.target][s].trigger(r,t.res)});else{if(!this.events[e][t.res.target][t.res.path])return;this.events[e][t.res.target][t.res.path].trigger(r,t.res)}})})},e=>{console.log("Event suppressed",e)}),this):this}saveCount(e,t,s){if(0===t.indexOf("_"))return void(s&&s());const r=(e,t,s,r)=>{const a=e.getDB(t)._tables[s].count,n=e.getDB(t)._tables[s].id;e.triggerQuery(t,Object.assign({},i.buildQuery(t,e,"_util","upsert"),{actionArgs:{key:"total_"+n,value:a}}),i.noop,()=>{r&&r()},e=>{r&&r(e),console.error("nSQL: Error updating table total.",e)})};s?r(this,e,t,s):(this._countTimers[e+t]||(this._countTimers[e+t]=l.throttle(void 0,r,1e3)),this._countTimers[e+t](this,e,t))}default(e,t,s){if(!e)return t;if(t=t||{},!s&&"string"!=typeof this.selectedTable)throw new Error("Must select table to generate defualts!");if(s=s||this.selectedTable,!this.getDB(e)._tables[s])throw new Error(`nSQL: Table "${s}" not found in database ${e} for generating default object!`);let r="";const a=(s,n,o)=>{let h={};if(n=n||{},o&&o.length&&-1!==o.indexOf("[]"))return Array.isArray(n)?n.map(e=>a(s,e,o.slice(0,o.lastIndexOf("[]")))):[];let l=!1;if(s.forEach(s=>{if("*"!==s.key){if(s.model)if(-1!==s.type.indexOf("[]")){const e=void 0!==n?n[s.key]:[];Array.isArray(e)?h[s.key]=e.map(e=>a(s.model,e,s.type.slice(0,s.type.lastIndexOf("[]")))):h[s.key]=[]}else h[s.key]=a(s.model,void 0!==n?n[s.key]:void 0);else{let a=void 0!==n[s.key]?i.cast(e,s.type,n[s.key],!1,this):"function"==typeof s.default?s.default(t):s.default;void 0!==s.max&&a>s.max&&(r=`Data error, column ${s.key} can't be greater than ${s.max}!`),void 0!==s.min&&a<s.min&&(r=`Data error, column ${s.key} can't be less than ${s.min}!`),h[s.key]=a}!s.notNull||null!==h[s.key]&&void 0!==h[s.key]||(r=`Data error, ${s.key} cannot be null!`),null===h[s.key]&&(h[s.key]=void 0)}else l=!0}),r.length)throw new Error(r);if(l&&n){const e=s.map(e=>e.key);Object.keys(n).filter(t=>-1===e.indexOf(t)).forEach(e=>{h[e]=n[e]})}return h};return a(this.getDB(e)._tables[s].columns,t)}rawDump(e,t,s){const r=t?e:Object.keys(this.getDB()._tables).filter(t=>!e.length||-1!==e.indexOf(t));return i.chainAsync(r,(e,r,a,n)=>{if(t){const t=-1!==e.indexOf(":")?e.split(":")[0]:e,r=-1!==e.indexOf(":")?[e.split(":")[1]]:Object.keys(this.getDB()._tables[e].indexes);i.chainAsync(r,(e,r,a,n)=>{i.adapterFilters(this.selectedDB,this).readIndexKeys(t,e,"all",void 0,void 0,!1,(r,i)=>{s(t+"."+e,{indexId:i,rowId:r})},a,n)}).then(a).catch(n)}else i.adapterFilters(this.selectedDB,this).readMulti(e,"all",void 0,void 0,!1,t=>{s(e,t)},a,n||i.noop)})}rawImport(e,t,s){let r=0;const a=Object.keys(e).reduce((t,s)=>t+=e[s].length,0),n=this.selectedDB,o=Object.keys(this.getDB()._tables),h=t?Object.keys(e):Object.keys(e).filter(e=>-1!==o.indexOf(e));return i.chainAsync(h,(o,h,l,d)=>{if(t){const t=o.split(".")[0],s=o.split(".")[1];i.chainAsync(e[o],(e,r,a,o)=>{i.adapterFilters(n,this).addIndexValue(t,s,e.rowId,e.indexId,a,o)}).then(l).catch(d)}else{const t=this.getDB()._tables[o].pkCol,h=this.getDB().adapter.batch;if(h){const t=this.getDB()._tableIds[o];h.apply(this.getDB().adapter,[t,e[o].map(e=>(r++,s&&s(Math.round(r/a*1e4)/100),{type:"put",data:e})),()=>{l()},d])}else console.warn("Batch import not using transaction, transactions not supported by adapter!"),i.chainAsync(e[o],(e,h,l,d)=>{i.deepGet(t,e)||!d?i.adapterFilters(n,this).write(o,i.deepGet(t,e),e,e=>{l(),r++,s&&s(Math.round(r/a*1e4)/100)},d||i.noop):d("No primary key found, can't import: "+JSON.stringify(e))}).then(()=>{this.saveCount(n,o),l()}).catch(d)}})}disconnect(e){return new Promise((t,s)=>{const r=e?[e]:Object.keys(this.dbs);i.chainAsync(r,(e,t,s,r)=>{this.doFilter(e,"disconnect",{},()=>{i.adapterFilters(e,this).disconnect(()=>{delete this.dbs[e],s()},r)},r)}).then(()=>{t()}).catch(s)})}extend(e,...t){return new Promise((s,r)=>{this.doFilter(this.selectedDB,"extend",{scope:e,args:t,res:null},s,r)})}loadJS(e,t,s){const r=this.selectedTable;if("string"!=typeof r)return Promise.reject("nSQL: Can't load JS into temporary table!");const a=e.length;let n=0;return(s?i.allAsync:i.chainAsync)(e,(e,s,o,h)=>{this.triggerQuery(this.selectedDB,Object.assign({},i.buildQuery(this.selectedDB,this,r,"upsert"),{actionArgs:e}),e=>{},()=>{n++,t&&t(n/a*1e4/100),o()},h)})}JSONtoCSV(e,t,s){let r=[];if(!e.length)return"";let i=[];return s?i=s:(e.forEach(e=>{i=Object.keys(e).concat(i)}),i=i.filter((e,t,s)=>s.indexOf(e)===t)),t&&r.push(i.map(e=>`"${e}"`).join(",")),e.forEach(e=>{r.push(i.map(t=>null===e[t]||void 0===e[t]?"":"string"==typeof e[t]?'"'+e[t].replace(/\"/g,'""')+'"':"boolean"==typeof e[t]?!0===e[t]?"true":"false":"object"==typeof e[t]?'"'+JSON.stringify(e[t]).replace(/\"/g,'""')+'"':e[t]).join(","))}),r.join("\n")}csvToArray(e){let t,s="",r=[""],i=[r],a=0,n=0,o=!0;for(t of e)'"'===t?(o&&t===s&&(r[a]+=t),o=!o):","===t&&o?t=r[++a]="":"\n"===t&&o?("\r"===s&&(r[a]=r[a].slice(0,-1)),r=i[++n]=[t=""],a=0):r[a]+=t,s=t;return i[0]}CSVtoJSON(e,t){let s=[];return e.split(/\r?\n|\r|\t/gim).map((e,r)=>{if(0!==r){if(String(e).trim().length<1)return;let r=this.csvToArray(e);if(!r)return;r=r.map(e=>e.trim());let i=s.length,a={};for(;i--;)if(r[i])if("true"===r[i]||"false"===r[i])a[s[i]]="true"===r[i];else if(0===r[i].indexOf("{")||0===r[i].indexOf("["))try{a[s[i]]=JSON.parse(r[i])}catch(e){a[s[i]]=r[i]}else 0===r[i].indexOf('"')?a[s[i]]=r[i].slice(1,r[i].length-1).replace(/\"\"/gim,'"'):a[s[i]]=r[i];return t?t(a):a}s=e.split(",").map(e=>e.substring(1,e.length-1))}).filter(e=>e)}loadCSV(e,t,s,r){const a=this.selectedTable;if("string"!=typeof a)return Promise.reject("nSQL: Can't load CSV into temporary table!");const n=this.CSVtoJSON(e,t),o=r?i.allAsync:i.chainAsync;let h=0;return o(n,(e,t,r,o)=>{this.triggerQuery(this.selectedDB,Object.assign({},i.buildQuery(this.selectedDB,this,a,"upsert"),{actionArgs:e}),i.noop,()=>{h++,s&&s(Math.round(h/n.length*1e4)/100),r()},o||i.noop)})}}t.nanoSQL=u,t.nSQLv1Config=e=>{let t={},s={},r="";const i=e=>((r=e||r)&&!t[r]&&(t[r]={name:r,model:{},indexes:{},actions:[],views:[]}),{model:s=>{let a={};return t[r].model=s.reduce((e,t)=>{const s=t.key+":"+t.type;return e[s]={},t.props&&(-1!==t.props.indexOf("pk")&&(e[s].pk=!0),-1!==t.props.indexOf("ai")&&(e[s].ai=!0),a&&-1!==t.props.indexOf("idx")&&(a[s]={})),e},{}),t[r].indexes=a,i(e)},actions:s=>(t[r].actions=s,i(e)),views:s=>(t[r].views=s,i(e)),config:t=>(s=t,i(e)),table:e=>i(e),rowFilter:s=>(t[r].filter=s,i(e))});return e(i),Object.assign({id:s.id||"nanoSQL_DB"},s,{tables:Object.keys(t).map(e=>t[e])})};let p=new u;t.nSQL=e=>p.selectTable(e),"undefined"!=typeof window&&(window["@nano-sql"]||(window["@nano-sql"]={}),window["@nano-sql"].core={nSQL:t.nSQL,nanoSQL:u,utilities:l,nSQLv1Config:t.nSQLv1Config},window["@nano-sql/core"]=window["@nano-sql"].core)},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(){this.eventListeners={}}return e.prototype.on=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},e.prototype.off=function(e,t){var s=this;this.eventListeners[e]&&this.eventListeners[e].length&&this.eventListeners[e].forEach(function(r,i){r===t&&s.eventListeners[e].splice(i,1)})},e.prototype.trigger=function(e){for(var t=[],s=1;s<arguments.length;s++)t[s-1]=arguments[s];this.eventListeners[e]&&this.eventListeners[e].forEach(function(e){return e.apply(void 0,t)})},e}();t.ReallySmallEvents=s,t.RSE=new s},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(0),i=s(3),a={},n=(e,...t)=>t.map(t=>parseFloat(isNaN(t)?r.getFnValue(e,t):t));t.attachDefaultFns=e=>{e.functions={COUNT:{type:"A",aggregateStart:{result:0,row:{}},call:(e,t,s,i)=>(i&&"*"!==i?r.getFnValue(t,i)&&s.result++:s.result++,s.row=t,s)},MAX:{type:"A",aggregateStart:{result:void 0,row:{}},call:(e,t,s,i)=>{let a=r.getFnValue(t,i)||0;return void 0===s.result?(s.result=a,s.row=t):a>s.result&&(s.result=a,s.row=t),s}},MIN:{type:"A",aggregateStart:{result:void 0,row:{}},call:(e,t,s,i)=>{let a=r.getFnValue(t,i)||0;return void 0===s.result?(s.result=a,s.row=t):a<s.result&&(s.result=a,s.row=t),s}},GREATEST:{type:"S",call:(e,t,s,...i)=>{return{result:i.map(e=>isNaN(e)?r.getFnValue(t,e):parseFloat(e)).sort((e,t)=>e<t?1:-1)[0]}}},LEAST:{type:"S",call:(e,t,s,...i)=>{return{result:i.map(e=>isNaN(e)?r.getFnValue(t,e):parseFloat(e)).sort((e,t)=>e>t?1:-1)[0]}}},AVG:{type:"A",aggregateStart:{result:0,row:{},total:0,records:0},call:(e,t,s,i)=>{const a=parseFloat(r.getFnValue(t,i)||0)||0;return s.total+=isNaN(a)?0:a,s.records++,s.result=s.total/s.records,s.row=t,s}},SUM:{type:"A",aggregateStart:{result:0,row:{}},call:(e,t,s,i)=>{const a=parseFloat(r.getFnValue(t,i)||0)||0;return s.result+=isNaN(a)?0:a,s.row=t,s}},ADD:{type:"S",call:(e,t,s,...r)=>({result:n(t,r).reduce((e,t,s)=>0===s?t:e+t)})},SUB:{type:"S",call:(e,t,s,...r)=>({result:n(t,r).reduce((e,t,s)=>0===s?t:e-t)})},DIV:{type:"S",call:(e,t,s,r,...i)=>({result:n(t,i).reduce((e,t,s)=>0===s?t:e/t)})},MULT:{type:"S",call:(e,t,s,...r)=>({result:n(t,r).reduce((e,t,s)=>0===s?t:e*t)})},MOD:{type:"S",call:(e,t,s,r,i)=>{const[a,o]=n(t,r,i);return{result:a%o}}},PI:{type:"S",call:(e,t,s)=>({result:Math.PI})},TRUNCATE:{type:"S",call:(e,t,s,r,i)=>{const[a,o]=n(t,r,i);return{result:parseFloat(a.toFixed(o))}}},LOWER:{type:"S",call:(e,t,s,i)=>({result:String(r.getFnValue(t,i)).toLowerCase()})},TRIM:{type:"S",call:(e,t,s,i)=>({result:String(r.getFnValue(t,i)).trim()})},FORMAT_NUMBER:{type:"S",call:(e,t,s,r,i)=>{const[a,o]=n(t,r,i||2);return{result:a.toFixed(o).toLocaleString()}}},UPPER:{type:"S",call:(e,t,s,i)=>({result:String(r.getFnValue(t,i)).toUpperCase()})},CAST:{type:"S",call:(e,t,s,i,a)=>({result:r.cast(e.databaseID,r.getFnValue(t,a),r.getFnValue(t,i),!1,e.parent)})},CONCAT:{type:"S",call:(e,t,s,...i)=>({result:i.map(e=>r.getFnValue(t,e)).join("")})},CONCAT_WS:{type:"S",call:(e,t,s,i,...a)=>({result:a.map(e=>r.getFnValue(t,e)).join(r.getFnValue(t,i))})},REPLACE:{type:"S",call:(e,t,s,i,a,n)=>{const o=String(r.getFnValue(t,i)),h=String(r.getFnValue(t,a)),l=String(r.getFnValue(t,n));return{result:o.replace(h,l)}}},STRCMP:{type:"S",call:(e,t,s,i,a)=>{const n=String(r.getFnValue(t,i)),o=String(r.getFnValue(t,a));return n<o?{result:-1}:n>o?{result:1}:{result:0}}},LEVENSHTEIN:{type:"S",call:(e,t,s,n,o)=>{const h=r.getFnValue(t,n),l=r.getFnValue(t,o),d=h+"::"+l;return a[d]||(a[d]=i(h,l)),{result:a[d]}}},IF:{type:"S",call:(e,t,s,i,a,n)=>{const o=i.split(/<|=|>|<=|>=/gim).map(e=>isNaN(e)?r.getFnValue(t,e):parseFloat(e)),h=i.match(/<|=|>|<=|>=/gim)[0];if(!h)return{result:r.getFnValue(t,n)};switch(h){case"=":return o[0]==o[1]?r.getFnValue(t,a):r.getFnValue(t,n);case">":return o[0]>o[1]?r.getFnValue(t,a):r.getFnValue(t,n);case"<":return o[0]<o[1]?r.getFnValue(t,a):r.getFnValue(t,n);case"<=":return o[0]<=o[1]?r.getFnValue(t,a):r.getFnValue(t,n);case">=":return o[0]<o[1]?r.getFnValue(t,a):r.getFnValue(t,n);default:return{result:r.getFnValue(t,n)}}}},CROW:{type:"S",call:(t,s,i,a,n,o)=>{const h=r.getFnValue(s,a+".lat"),l=r.getFnValue(s,a+".lon");return{result:r.crowDistance(h,l,parseFloat(n),parseFloat(o),e.planetRadius)}},checkIndex:(t,s,i)=>{if("<"===i[1]||"<="===i[1]){const a="string"==typeof t.table?e.getDB(t.databaseID)._tables[t.table].indexes:{},n=r.resolvePath(s[0]);let o=[];if(Object.keys(a).forEach(e=>{const t=a[e];"float"===t.type&&r.objectsEqual(t.path.slice(0,t.path.length-1),n)&&o.push(e.replace(".lat","").replace(".lon",""))}),2===o.length)return{index:o[0],parsedFn:{name:"CROW",args:s},comp:i[1],value:i[2]}}return!1},queryIndex:(t,s,i,a,n,o)=>{const h=t.table,l=`${s.index}.lat`,d=`${s.index}.lon`,c=s.comp,u=parseFloat(s.value||"0"),p=parseFloat(s.parsedFn?s.parsedFn.args[1]:"0"),y=parseFloat(s.parsedFn?s.parsedFn.args[2]:"0"),g=u/(2*e.planetRadius*Math.PI)*360;let b=[-1,1].map(e=>p+g*e),f=[],_=[],m=!1;const D=Math.max(90-g,0);if(Math.abs(b[0])>D||Math.abs(b[1])>D)m=!0,b[0]<-1*D&&(b=[-90,b[1]]),b[1]>D&&(b=[b[0],90]);else{const e=Math.max(Math.abs(b[0]),Math.abs(b[1]));if(f=[-1,1].map(t=>{return y+g*t/Math.cos(r.deg2rad(e))}),Math.abs(f[0])>180){const e=Math.abs(f[0])-180;_=[180-e,180]}if(Math.abs(f[1])>180){const e=Math.abs(f[1])-180;_=[-180,-180+e]}}let I={};r.allAsync([l,d,d],(s,i,a,n)=>{const o=[b,f,_][i];o.length?r.adapterFilters(t.databaseID,e,t).readIndexKeys(h,s,"range",o[0],o[1],!1,(e,t)=>{I[e]?I[e].num++:I[e]={key:e,lat:0,lon:0,num:0},0===i?I[e].lat=t-90:I[e].lon=t-180},()=>{a(null)},n):a(null)}).then(()=>{let h=0;const l=(m?Object.keys(I):Object.keys(I).filter(t=>{if(I[t].num<1)return!1;const s=r.crowDistance(I[t].lat,I[t].lon,p,y,e.planetRadius);return"<"===c?s<u:s<=u})).map(e=>I[e]);m||!i?r.allAsync(l,(n,o,l,d)=>{r.adapterFilters(t.databaseID,t.parent,t).read(t.table,n.key,n=>{if(!n)return void l(null);if(!m)return a(n,o),void l(null);const d=r.deepGet((s.parsedFn?s.parsedFn.args[0]:"")+".lat",n),g=r.deepGet((s.parsedFn?s.parsedFn.args[0]:"")+".lon",n),b=r.crowDistance(d,g,p,y,e.planetRadius);("<"===c?b<u:b<=u)&&(a(i?r.deepGet(e.getDB(t.databaseID)._tables[t.table].pkCol,n):n,h),h++),l(null)},d)}).catch(o).then(()=>{n()}):l.forEach((e,t)=>{a(e.key,t)})}).catch(o)}}},(Object.getOwnPropertyNames?Object.getOwnPropertyNames(Math):["abs","acos","asin","atan","atan2","ceil","cos","exp","floor","log","pow","random","round","sin","sqrt","tan"]).filter(e=>-1===["min","max"].indexOf(e)).forEach(t=>{e.functions[t.toUpperCase()]={type:"S",call:(e,s,r,...i)=>({result:Math[t].apply(null,n(s,...i))})}})}},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(1),i=s(0),a=s(5);t.secondaryIndexQueue={};const n={};class o{constructor(e,t,s,r,a,n){this.databaseID=e,this.nSQL=t,this.query=s,this.progress=r,this.complete=a,this.error=n,this._queryBuffer=[],this._stream=!0,this._selectArgs=[],this._pkOrderBy=!1,this._idxOrderBy=!1,this._sortGroups=[],this._sortGroupKeys={},this._indexLocks={},this.query.state="processing",this._indexesUsed=[],this._startTime=Date.now();const o=s.action.toLowerCase().trim();if(this._orderByRows=this._orderByRows.bind(this),this._onError=this._onError.bind(this),-1===["select","clone","create table","create table if not exists","show tables"].indexOf(o)&&"string"!=typeof s.table)return this.query.state="error",void this.error('Only "select", "clone" & "create table" queries are available for this resource!');if(!("string"!=typeof s.table||this.databaseID&&this.nSQL.getDB(this.databaseID).state.connected))return this.query.state="error",void this.error("Can't execute query before the database has connected!");const h=(e,t)=>"string"==typeof this.query.table&&this.query.table?e&&!this.query.actionArgs?(this.query.state="error",void this.error(`${this.query.action} query requires an additional argument!`)):void t():(this.query.state="error",void this.error(`${this.query.action} query requires a table argument!`)),l=()=>{"error"!==this.query.state&&(this.query.state="complete",this.complete())};switch(this.query.cacheID||(this.query.cacheID=this.query.queryID),o){case"select":this._select(l,this.error);break;case"total":h(!1,()=>{const e=this.query.actionArgs;if(e&&e.rebuild)try{i.adapterFilters(this.databaseID,this.nSQL,this.query).getTableIndexLength(this.query.table,e=>{this.nSQL.getDB(this.databaseID)._tables[this.query.table].count=e,this.nSQL.saveCount(this.databaseID||"",this.query.table,t=>{t?this.error(t):(this.progress({total:e},0),this.complete())})},this.error)}catch(e){this.error(e)}else try{const e=this.nSQL.getDB(this.databaseID)._tables[this.query.table].count;this.progress({total:e},0),this.complete()}catch(e){this.error(e)}});break;case"upsert":h(!0,()=>{this._upsert(this.progress,this.complete,this.error)});break;case"delete":h(!1,()=>{this._delete(this.progress,this.complete,this.error)});break;case"show tables":this._showTables();break;case"describe":this._describe();break;case"describe indexes":this._describe("idx");break;case"drop":case"drop table":this._dropTable(this.query.table,l,this.error);break;case"create table":case"create table if not exists":this._createTable(this.query.actionArgs,!1,r,l,this.error);break;case"alter table":h(!0,()=>{this._createTable(this.query.actionArgs,!0,r,l,this.error)});break;case"rebuild indexes":h(!1,()=>{this._rebuildIndexes(this.progress,l,this.error)});break;case"conform rows":h(!1,()=>{this._conform(this.progress,l,this.error)});break;case"clone":h(!0,()=>{this._clone(this.progress,l,this.error)});break;default:this.nSQL.doFilter(this.databaseID,"customQuery",{res:void 0,query:this.query,onRow:r,complete:a,error:n},()=>{this.query.state="error",this.error(`Query type "${s.action}" not supported!`)},e=>{this.query.state="error",this.error(e)})}}_clone(e,t,s){const r=this.query.actionArgs&&this.query.actionArgs.mode,n=this.query.actionArgs&&this.query.actionArgs.getAdapter,o=this.query.actionArgs&&this.query.actionArgs.id||this.query.parent.getDB(this.databaseID).state.id;if(!o||!r)return void s("Id & Mode required for clone query!");const h=a.resolveMode(r),l="*"!==this.query.table?[this.query.table]:Object.keys(this.nSQL.getDB(this.databaseID)._tables);let d={};h.connect(o,()=>{i.chainAsync(l,(t,r,a,n)=>{const o=this.query.parent.getDB(this.databaseID)._tables[t];o?h.createTable(this.query.parent.getDB(this.databaseID)._tableIds[o.name],o,()=>{d[o.name]=this.query.parent.getDB(this.databaseID)._tableIds[o.name],i.allAsync(Object.keys(o.indexes),(e,t,s,r)=>{const i=o.indexes[e];h.createIndex(this.query.parent.getDB(this.databaseID)._tableIds[o.name],e,i.type,s,r)}).then(()=>{const t=new i._nanoSQLQueue((t,s,r,a)=>{e({target:o.name,targetId:this.query.parent.getDB(this.databaseID)._tableIds[o.name],object:t},s),s++,h.write(this.query.parent.getDB(this.databaseID)._tableIds[o.name],i.deepGet(o.pkCol,t),t,r,a)},s,()=>{i.chainAsync(Object.keys(o.indexes),(t,s,r,a)=>{o.indexes[t];i.adapterFilters(this.databaseID,this.query.parent,this.query).readIndexKeys(o.name,t,"all",void 0,void 0,!1,(r,n)=>{e({target:this.query.parent.getDB(this.databaseID)._tableIds[o.name]+"."+t,targetId:o.name+"."+t,object:{key:n,rowId:r}},s),s++,h.addIndexValue(this.query.parent.getDB(this.databaseID)._tableIds[o.name],t,r,n,i.noop,a)},r,a)}).then(()=>{a()}).catch(s)});i.adapterFilters(this.databaseID,this.query.parent,this.query).readMulti(o.name,"all",void 0,void 0,!1,(e,s)=>{t.newItem(e)},()=>{t.finished()},s)}).catch(s)},s):n(`Table ${o} not found!`)}).then(()=>{h.createTable("_util",Object.assign({},i.blankTableDefinition,{name:"_util",model:{"key:string":{pk:!0},"value:any":{}}}),()=>{h.read("_util","tableIds",e=>{const r=Object.assign({},e&&e.value||{},d);h.write("_util","taleIds",{key:"tableIds",value:r},()=>{n?(n(h),t()):h.disconnect(()=>{t()},s)},s)},s)},s)}).catch(s)},s)}_conform(e,t,s){const a=this.query.table,n=this.query.actionArgs||function(e){return e};if(this._whereArgs=this.query.where?this._parseWhere(this.query.where,"string"!=typeof this.query.table||void 0!==this.query.union):{type:r.IWhereType.none},!this.databaseID||!this.nSQL.getDB(this.databaseID)._tables[a])return void s(new Error(`Table ${a} not found for conforming!`));const o=new i._nanoSQLQueue((t,r,n,o)=>{const h=this.nSQL.default(this.databaseID||"",t,a);this.nSQL.doFilter(this.databaseID,"conformRow",{res:h,oldRow:t,query:this.query},s=>{this._diffUpdates(this.query.table,t,s.res,()=>{const o={target:a,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-this._startTime,result:s.res,oldRow:t,query:this.query,indexes:this._indexesUsed};this.nSQL.getDB(this.databaseID).state.hasAnyEvents&&(this.nSQL.triggerEvent(this.databaseID||"",o),Object.keys(this.nSQL.events[this.databaseID||""][this.query.table]).forEach(e=>{"*"!==e&&(i.objectsEqual(i.deepGet(e,t),i.deepGet(e,s.res))||this.nSQL.triggerEvent(this.databaseID||"",{target:this.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-this._startTime,result:s.res,oldRow:t,query:this.query,indexes:this._indexesUsed},!0))})),this._startTime=Date.now(),e(this.query.returnEvent?o:s.res,r),0,n()},o)},s)},s,()=>{t()});this._getRecords((e,t)=>{o.newItem(n(e))},()=>{o.finished()},s)}_getTable(e,t,s,r){const i=this.query.cacheID;if("function"==typeof s){if(n[i]||(n[i]={}),!n[i][e])return n[i][e]={loading:!0,rows:[],cache:!0},void s(t).then(t=>{const s=t.cache&&!t.filtered||!1;n[i][e]={loading:!1,rows:s?t.rows:[],cache:s},r(t)}).catch(this._onError);if(n[i][e].loading)return void setTimeout(()=>{this._getTable(e,t,s,r)},10);if(n[i][e].cache)return void r({filtered:!1,rows:n[i][e].rows,cache:!0});s(t).then(e=>{r(e)}).catch(this._onError)}else r({rows:s,filtered:!1,cache:!1})}_maybeJoin(e,t,s,r){if(!e[0])return s(t),void r();const a=(t,r,n)=>{const o=e[r];let h=0,l=[];if("cross"!==o.type&&!o.on)return this.query.state="error",void this.error(new Error("Non 'cross' joins require an 'on' parameter!"));const d=new Error("Must use 'AS' when joining temporary tables!");if("string"!=typeof o.with.table&&!o.with.as)return this.query.state="error",void this.error(d);if("string"!=typeof this.query.table&&!this.query.tableAS)return this.query.state="error",void this.error(d);const c=new i._nanoSQLQueue((t,i,n,o)=>{e[r+1]?a(t,r+1,n):(s(t),n())},this.error,n),u="string"==typeof o.with.table?this.nSQL.getDB(this.databaseID)._tables[o.with.table].pkCol:[],p=String(o.with.as||o.with.table),y=String(this.query.tableAS||this.query.table);this.nSQL.triggerQuery(this.databaseID,Object.assign({},i.buildQuery(this.databaseID,this.nSQL,o.with.table,"select"),{tableAS:o.with.as,cacheID:this.query.cacheID,where:o.on&&"cross"!==o.type?this._buildCombineWhereJoin(o.on,o.with.as||o.with.table,t):void 0}),e=>{h++,"right"!==o.type&&"outer"!==o.type||l.push(u?i.deepGet(u,e):i.hash(JSON.stringify(e))),c.newItem(Object.assign({},t,{[p]:e}))},()=>{switch(o.type){case"left":0===h&&c.newItem(Object.assign({},t,{[p]:void 0})),c.finished();break;case"inner":case"cross":c.finished();break;case"outer":case"right":0===h&&"outer"===o.type&&c.newItem(Object.assign({},t,{[p]:void 0})),this.nSQL.triggerQuery(this.databaseID,Object.assign({},i.buildQuery(this.databaseID,this.nSQL,o.with.table,"select"),{cacheID:this.query.cacheID,where:u?[u,"NOT IN",l]:void 0}),e=>{(u||-1===l.indexOf(i.hash(JSON.stringify(e))))&&c.newItem(Object.assign({},t,{[y]:void 0,[p]:e}))},()=>{c.finished()},e=>{this.query.state="error",this.error(e)})}},e=>{this.query.state="error",this.error(e)})};a({[String(this.query.tableAS||this.query.table)]:t},0,r)}_select(e,t){if(this._whereArgs=this.query.where?this._parseWhere(this.query.where,"string"!=typeof this.query.table||void 0!==this.query.union):{type:r.IWhereType.none},this._havingArgs=this.query.having?this._parseWhere(this.query.having,!0):{type:r.IWhereType.none},this._parseSelect(),"error"===this.query.state)return;const s=[this.query.offset||0,(this.query.offset||0)+(this.query.limit||0)],a=s[0]+s[1]>0;let o={};const h=e=>(this.query.distinct||[]).reduce((t,s)=>t+JSON.stringify(i.deepGet(s,e)||{}),"");if(this.query.union){let t=[],r=[],l=0;return void i.chainAsync(this.query.union.queries,(e,n,d)=>{e().then(e=>{r.length||(r=Object.keys(e[0])),this.query.where&&(e=e.filter((e,t)=>this._where(e,this._whereArgs.slowWhere))),e=e.map(e=>{if(this.query.union&&"distinct"===this.query.union.type){const s=i.hash(JSON.stringify(e));if(0===n)t.push(s);else{if(-1!==t.indexOf(s))return;t.push(s)}}return Object.keys(e).reduce((t,s,i)=>(i<r.length&&(t[r[i]]=e[s]),t),{})}).filter(e=>e),this.query.orderBy?this._queryBuffer=this._queryBuffer.concat(e.map(e=>{let t=!0;if(this.query.distinct){const s=h(e);o[s]?t=!1:o[s]=!0}const s=this._streamAS(e);return(!this.query.having||this._where(s,this._havingArgs.slowWhere))&&t?s:void 0}).filter(e=>e)):e.forEach((e,t)=>{let r=!0;if(this.query.distinct){const t=h(e);o[t]?r=!1:o[t]=!0}if(!r)return;const i=this._streamAS(e);(!this.query.having||this._where(i,this._havingArgs.slowWhere))&&(a&&!this._didRangeAlready?l>=s[0]&&l<s[1]&&this.progress(i,l):this.progress(i,l),l++)}),d()})}).then(()=>{if(this.query.orderBy){const e=this.quickSort(this._queryBuffer,this._orderBy);(a&&!this._didRangeAlready?e.slice(s[0],s[1]):e).forEach(this.progress)}this.query.cacheID&&this.query.cacheID===this.query.queryID&&delete n[this.query.cacheID],e()})}const l=Array.isArray(this.query.join)?this.query.join:[this.query.join];let d=0;const c=new i._nanoSQLQueue((e,t,s,r)=>{if(this.query.graph)this._graph(this.query.graph||[],this.query.tableAS||this.query.table,e,u,(t,r)=>{let i=!0;if(this.query.distinct){const e=h(t);o[e]?i=!1:o[e]=!0}if(!i)return d++,void s();const a=this._streamAS(t);this.query.having?this._where(this._streamAS(e),this._havingArgs.slowWhere)&&this.progress(a,d):this.progress(a,d),d++,s()});else{let t=!0;if(this.query.distinct){const s=h(e);o[s]?t=!1:o[s]=!0}if(!t)return d++,void s();this.progress(this._streamAS(e),d),d++,s()}},this._onError,()=>{this.query.cacheID&&this.query.cacheID===this.query.queryID&&delete n[this.query.cacheID],e()});let u=0;const p=new i._nanoSQLQueue((e,t,r,i)=>{this._maybeJoin(l,e,e=>{this._stream?((!a||this._didRangeAlready||u>=s[0]&&u<s[1])&&c.newItem(e),u++):this._queryBuffer.push(e)},r)},this.error,()=>{this._stream?c.finished():i.allAsync(this._queryBuffer,(e,t,s)=>{this._graph(this.query.graph||[],this.query.tableAS||this.query.table,e,t,s)}).then(t=>{this._queryBuffer=t,this._groupByRows(),this.query.having&&(this._queryBuffer=this._queryBuffer.filter(e=>this._where(e,this._havingArgs.slowWhere))),this.query.orderBy&&!this._hasOrdered&&(this._orderBy.sort.length>1?this._queryBuffer=this.quickSort(this._queryBuffer,this._orderBy):this._queryBuffer.sort(this._orderByRows)),a&&!this._didRangeAlready&&(this._queryBuffer=this._queryBuffer.slice(s[0],s[1])),this._queryBuffer.forEach((e,t)=>{let s=!0;if(this.query.distinct){const t=h(e);o[t]?s=!1:o[t]=!0}s&&this.progress(this._streamAS(e,this._hasFn),t)}),this.query.cacheID&&this.query.cacheID===this.query.queryID&&delete n[this.query.cacheID],e()})}),y="string"==typeof this.query.table;let g=!(this.query.join||this.query.distinct||this.query.graph||this.query.actionArgs||this.query.having||this.query.groupBy);g&&this.query.orderBy&&(g=this._pkOrderBy),this._getRecords((e,t)=>{const r={target:this.query.table,path:"_all_",events:["select","*"],time:Date.now(),performance:Date.now()-this._startTime,result:e,query:this.query,indexes:this._indexesUsed};y&&this.nSQL.triggerEvent(this.databaseID,r),this._startTime=Date.now(),this.query.returnEvent?a?t>=s[0]&&t<s[1]&&this.progress(r,t):this.progress(r,t):g?a&&!this._didRangeAlready?t>=s[0]&&t<s[1]&&this.progress(e,t+s[0]):this.progress(e,t):p.newItem(e)},()=>{this.query.returnEvent||g?e():p.finished()},t)}_groupByRows(){if(!this.query.groupBy&&!this._hasAggrFn)return;if((this._groupBy?this._queryBuffer.sort((e,t)=>this._sortObj(e,t,this._groupBy)):this._queryBuffer).forEach((e,t)=>{const s=this._groupBy.sort.map(t=>String(t.fn?i.execFunction(this.query,t.fn,e,{result:void 0}).result:i.deepGet(t.path,e))).join(".");void 0===this._sortGroupKeys[s]&&(this._sortGroupKeys[s]=this._sortGroups.length);const r=this._sortGroupKeys[s];this._sortGroups[r]||this._sortGroups.push([]),this._sortGroups[r].push(e)}),this.query.orderBy&&(this._hasOrdered=!0,this._sortGroups=this._sortGroups.map(e=>e.sort((e,t)=>this._sortObj(e,t,this._orderBy)))),this._queryBuffer=[],this._hasAggrFn){const e=()=>this._selectArgs.reduce((e,t,s)=>{const r=t.value.split("(").shift();return t.isFn&&this.nSQL.functions[r]&&"A"===this.nSQL.functions[r].type&&(e[s]={idx:s,name:t.value,aggr:i.assign(this.nSQL.functions[r].aggregateStart)}),e},[]);if(this._sortGroups.forEach(t=>{const s=e(),r=s.filter(e=>e)[0];t.slice().reverse().forEach((e,t)=>{s.forEach((t,r)=>{t&&(s[r].aggr=i.execFunction(this.query,s[r].name,e,s[r].aggr))})}),this._queryBuffer.push(this._selectArgs.reduce((e,t,a)=>{const n=t.value;return e[t.as||n]=t.isFn&&s[a]?s[a].aggr.result:t.isFn?i.execFunction(this.query,t.value,s[r.idx].aggr.row,{result:void 0}).result:i.deepGet(t.value,s[r.idx].aggr.row)||null,e},{}))}),!this._queryBuffer.length){const t=e(),s=t.filter(e=>e)[0];this._queryBuffer.push(this._selectArgs.reduce((e,r,a)=>{const n=r.value;return e[r.as||n]=r.isFn&&t[a]?t[a].aggr.result:r.isFn?i.execFunction(this.query,r.value,t[s.idx].aggr.row,{result:void 0}).result:i.deepGet(r.value,t[s.idx].aggr.row)||null,e},{}))}}else this._sortGroups.forEach(e=>{this._queryBuffer.push(e.shift())})}_buildCombineWhereJoin(e,t,s){return"function"==typeof e?t=>e(t,s):("string"==typeof e[0]?[e]:e).map(e=>{if(Array.isArray(e[0]))return this._buildCombineWhereJoin(e,t,s);if("AND"===e||"OR"===e)return e;const r=i.resolvePath(e[0]),a=i.resolvePath(e[2]),n=r[0]!==t;return[n?a.slice(1).join("."):r.slice(1).join("."),n?-1!==e[1].indexOf(">")?e[1].replace(">","<"):e[1].replace("<",">"):e[1],i.deepGet(n?r:a,s)]})}_graph(e,t,s,r,a){const n=Array.isArray(e)?e:[e];n&&0!==n.length?i.allAsync(n,(e,r,a)=>{const n=new Error("Must use 'AS' when graphing temporary tables!");if("string"!=typeof e.with.table&&!e.with.as)return this.query.state="error",void this.error(n);if("string"!=typeof this.query.table&&!this.query.tableAS)return this.query.state="error",void this.error(n);s[e.key]=[];const o=this._buildCombineWhereJoin(e.on,e.with.as||e.with.table,{[t]:s});this._getTable(e.with.as||e.with.table,o,e.with.table,t=>{t.filtered?(t.rows.forEach(t=>{e.single?s[e.key]=t:s[e.key].push(t)}),a(null)):this.nSQL.triggerQuery(this.databaseID,Object.assign({},i.buildQuery(this.databaseID,this.nSQL,t.rows,"select"),{tableAS:e.with.as,actionArgs:e.select,where:o,limit:e.limit,offset:e.offset,orderBy:e.orderBy,groupBy:e.groupBy,graph:e.graph,cacheID:this.query.cacheID}),t=>{e.single?s[e.key]=t:s[e.key].push(t)},()=>{a(null)},this._onError)})}).then(()=>{a(s,r)}):a(s,r)}_upsert(e,t,s){if(this.query.actionArgs||(s("nSQL: Can't upsert without records!"),this.query.state="error"),-1!==this.query.table.indexOf(".")||-1!==this.query.table.indexOf("[")){const e=i.resolvePath(this.query.table);this.query.table=e.shift(),this.upsertPath=e}if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:r.IWhereType.none},"error"===this.query.state)return;let a=Array.isArray(this.query.actionArgs)?this.query.actionArgs:[this.query.actionArgs];const n=this.nSQL.getDB(this.databaseID)._tables[this.query.table];if(this._whereArgs.type===r.IWhereType.none)i.allAsync(a,(t,s,r,a)=>{const o=i.deepGet(n.pkCol,t);o?i.adapterFilters(this.databaseID,this.nSQL,this.query).read(this.query.table,o,i=>{i?this._updateRow(t,i,t=>{e(t,s),r(null)},a):this._newRow(t,t=>{e(t,s),r(null)},a)},a):this._newRow(t,t=>{e(t,s),r(null)},a)}).then(()=>{this.nSQL.saveCount(this.databaseID||"",this.query.table),t()}).catch(this._onError);else{if(a.length>1)return this.query.state="error",void s("Cannot upsert multiple records with where condition!");const r=new i._nanoSQLQueue((t,s,r,n)=>{const o=this.nSQL.getDB(this.query.databaseID)._tables[this.query.table].pkCol,h=i.deepGet(o,t),l=()=>{this.nSQL.getDB(this.query.databaseID)._tables[this.query.table].rowLocks[String(h)]?setTimeout(l,10):(this.nSQL.getDB(this.query.databaseID)._tables[this.query.table].rowLocks[String(h)]=!0,this._updateRow(a[0],t,t=>{delete this.nSQL.getDB(this.query.databaseID)._tables[this.query.table].rowLocks[String(h)],e(t,s),r()},n))};l()},s,()=>{t()});this._getRecords((e,t)=>{r.newItem(e)},()=>{r.finished()},s)}}_updateRow(e,t,s,r){this.nSQL.doFilter(this.databaseID,"updateRow",{res:e,row:t,query:this.query},e=>{let a=this.nSQL.default(this.databaseID,this.upsertPath?i.deepSet(this.upsertPath,i.maybeAssign(t),e.res):Object.assign({},t,e.res),this.query.table);const n=this.nSQL.getDB(this.databaseID)._tables[this.query.table].filter;n&&(a=n(a));const o=this.nSQL.getDB(this.databaseID)._tables[this.query.table].columns;let h=o.length;for(;h--;)o[h].immutable&&delete a[o[h].key];this.query.updateImmutable&&(a=Object.assign({},a,this.query.updateImmutable)),this._diffUpdates(this.query.table,t,a,()=>{const e={target:this.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-this._startTime,result:a,oldRow:t,query:this.query,indexes:this._indexesUsed};this.nSQL.doFilter(this.databaseID,"updateRowEvent",{res:e,query:this.query},e=>{"string"==typeof this.query.table&&(this.nSQL.triggerEvent(this.databaseID,e.res),this.nSQL.events[this.databaseID||""][this.query.table]&&Object.keys(this.nSQL.events[this.databaseID||""][this.query.table]).forEach(e=>{"*"!==e&&(i.objectsEqual(i.deepGet(e,t),i.deepGet(e,a))||this.nSQL.triggerEvent(this.databaseID,{target:this.query.table,path:e,events:["upsert","change","*"],time:Date.now(),performance:Date.now()-this._startTime,result:a,oldRow:t,query:this.query,indexes:this._indexesUsed},!0))}),this._startTime=Date.now()),s(this.query.returnEvent?e.res:a)},r)},r)},r)}_checkUniqueIndexes(e,t,s,r,a,n){i.allAsync(Object.keys(r),(a,n,o,h)=>{const l=this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes[a].props||{};if(l&&l.unique){let n=[];i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKey(e,a,r[a],e=>{e!==t&&n.push(e)},()=>{n.length>0?h({error:"Unique Index Collision!",row:s,query:this.query}):o(null)},h)}else o(null)}).then(a).catch(n)}_diffUpdates(e,t,s,r,a){const n=this._getIndexValues(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes,s),o=this._getIndexValues(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes,t),h=this.nSQL.getDB(this.databaseID)._tables[e];this._checkUniqueIndexes(e,i.deepGet(h.pkCol,t),t,n,()=>{i.allAsync(Object.keys(o).concat(["__pk__"]),(t,r,a,l)=>{if("__pk__"===t)i.adapterFilters(this.databaseID,this.nSQL,this.query).write(e,i.deepGet(h.pkCol,s),s,e=>{i.deepSet(h.pkCol,s,e),a(null)},l);else{const e=this.query.table;if(!1===i.objectsEqual(n[t],o[t]))if(h.indexes[t].isArray){let r=n[t].filter((e,s,r)=>-1===o[t].indexOf(e)),d=o[t].filter((e,s,r)=>-1===n[t].indexOf(e));i.allAsync([r,d],(r,a,n)=>{r.length?i.allAsync(r,(r,n,o)=>{this._updateIndex(e,t,r,i.deepGet(h.pkCol,s),0===a,()=>{o(null)},l)}).then(n):n(null)}).then(a)}else i.chainAsync(["rm","add"],(r,a,d)=>{switch(r){case"add":this._updateIndex(e,t,n[t],i.deepGet(h.pkCol,s),!0,()=>{d(null)},l);break;case"rm":this._updateIndex(e,t,o[t],i.deepGet(h.pkCol,s),!1,()=>{d(null)},l)}}).then(a);else a(null)}}).then(r).catch(a)},a)}_updateIndex(e,t,s,r,a,n,o){const h=this.query.databaseID+e+t;if(this._indexLocks[h]||(this._indexLocks[h]={}),!s&&0!==s)return void n();if(0===String(s).length)return void n();const l={table:e,indexName:t,value:s,pk:r,addToIndex:a,done:n,err:o,query:this.query,nSQL:this.nSQL};this.nSQL.doFilter(this.databaseID,"updateIndex",{res:l,query:this.query},e=>{const t=e.res,s=()=>{if(this._indexLocks[h][String(t.value)])setTimeout(s,10);else{this._indexLocks[h][String(t.value)]=!0,(t.addToIndex?i.adapterFilters(this.databaseID,t.nSQL,t.query).addIndexValue:i.adapterFilters(this.databaseID,t.nSQL,t.query).deleteIndexValue)(t.table,t.indexName,t.pk,t.value,()=>{delete this._indexLocks[h][String(t.value)],t.done(),n()},e=>{delete this._indexLocks[h][String(t.value)],t.err(e),n()})}};s()},o)}_newRow(e,t,s){const r=this.nSQL.getDB(this.databaseID)._tables[this.query.table].filter;r&&(e=r(e)),this.nSQL.doFilter(this.databaseID,"addRow",{res:e,query:this.query},e=>{const r=this.nSQL.getDB(this.databaseID)._tables[this.query.table];e.res=this.nSQL.default(this.databaseID,i.maybeAssign(this.upsertPath?i.deepSet(this.upsertPath,{},e.res):e.res),this.query.table);const a=i.deepGet(r.pkCol,e.res),n=this._getIndexValues(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes,e.res);this._checkUniqueIndexes(this.query.table,a,e.res,n,()=>{i.adapterFilters(this.databaseID,this.nSQL,this.query).write(this.query.table,a,e.res,o=>{i.deepSet(r.pkCol,e.res,o),i.allAsync(Object.keys(n),(e,t,s,o)=>{if(r.indexes[e].isArray){const t=n[e]||[];i.allAsync(t,(t,s,r)=>{this._updateIndex(this.query.table,e,t,a,!0,()=>{r(null)},o)}).then(()=>{s(null)}).catch(o)}else this._updateIndex(this.query.table,e,n[e],a,!0,()=>{s(null)},o)}).then(()=>{const r={target:this.query.table,path:"*",events:["upsert","change","*"],time:Date.now(),performance:Date.now()-this._startTime,result:e.res,oldRow:void 0,query:this.query,indexes:this._indexesUsed};this.nSQL.doFilter(this.databaseID,"addRowEvent",{res:r,query:this.query},s=>{"string"==typeof this.query.table&&this.nSQL.triggerEvent(this.databaseID,s.res),this._startTime=Date.now(),this.nSQL.getDB(this.databaseID)._tables[this.query.table].count++,t(this.query.returnEvent?s.res:e.res)},s)})},s)},s)},s)}_delete(e,t,s){if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:r.IWhereType.none},"error"===this.query.state)return;const a=this.nSQL.getDB(this.databaseID)._tables[this.query.table],n=new i._nanoSQLQueue((t,s,n,o)=>{new Promise((e,s)=>{const a=this.query.table;this.nSQL.getDB(this.databaseID)._fkRels[a]&&this.nSQL.getDB(this.databaseID)._fkRels[a].length?i.allAsync(this.nSQL.getDB(this.databaseID)._fkRels[a],(e,s,a,n)=>{const o=i.deepGet(e.selfPath,t),h=i.cast(this.databaseID,"any[]",e.selfIsArray?o:[o]);i.allAsync(h,(t,s,o,h)=>{switch(e.onDelete){case r.InanoSQLFKActions.RESTRICT:let s=0;i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKey(e.childTable,e.childIndex,t,e=>{s++},()=>{s>0?h("Foreign key restraint error, can't delete!"):o()},n);break;case r.InanoSQLFKActions.CASCADE:let l=[];i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKey(e.childTable,e.childIndex,t,e=>{l.push(e)},()=>{this.nSQL.triggerQuery(this.databaseID,Object.assign({},i.buildQuery(this.databaseID,this.nSQL,e.childTable,"delete"),{where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",l]}),i.noop,o,h)},n);break;case r.InanoSQLFKActions.SET_NULL:let d=[];i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKey(e.childTable,e.childIndex,t,e=>{d.push(e)},()=>{this.nSQL.triggerQuery(this.databaseID,Object.assign({},i.buildQuery(this.databaseID,this.nSQL,e.childTable,"upsert"),{actionArgs:{[e.childPath.join(".")]:null},where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",l]}),i.noop,o,h)},n);break;default:a()}}).then(a).catch(n)}).then(e).catch(s):e()}).then(()=>{this._removeRowAndIndexes(a,t,t=>{e(t,s),this.nSQL.getDB(this.databaseID)._tables[a.name].count--,n()},o)}).catch(o)},s,()=>{t()});this._getRecords((e,t)=>{n.newItem(e)},()=>{this.nSQL.saveCount(this.databaseID||"",a.name),n.finished()},s)}_removeRowAndIndexes(e,t,s,r){const a=this._getIndexValues(e.indexes,t);this.nSQL.doFilter(this.databaseID,"deleteRow",{res:t,query:this.query},t=>{i.allAsync(Object.keys(a).concat(["__del__"]),(s,n,o)=>{if("__del__"===s)i.adapterFilters(this.databaseID,this.nSQL,this.query).delete(this.query.table,i.deepGet(e.pkCol,t.res),()=>{o(null)},e=>{this.query.state="error",r(e)});else if(e.indexes[s].isArray){const n=a[s]||[];i.allAsync(n,(a,n,o)=>{this._updateIndex(this.query.table,s,a,i.deepGet(e.pkCol,t.res),!1,()=>{o(null)},r)}).then(o)}else this._updateIndex(this.query.table,s,a[s],i.deepGet(e.pkCol,t.res),!1,()=>{o(null)},this._onError)}).then(()=>{const e={target:this.query.table,path:"_all_",events:["change","delete","*"],time:Date.now(),performance:Date.now()-this._startTime,result:t.res,query:this.query,indexes:this._indexesUsed};this.nSQL.doFilter(this.databaseID,"deleteRowEvent",{res:e,query:this.query},e=>{"string"==typeof this.query.table&&this.nSQL.triggerEvent(this.databaseID,e.res),this._startTime=Date.now(),s(this.query.returnEvent?e.res:t.res)},r)}).catch(r)},r)}_getIndexValues(e,t){return Object.keys(e).reduce((s,r)=>{const a=i.deepGet(e[r].path,t),n=e[r].isDate?"string":e[r].type;return s[r]=e[r].isArray?(Array.isArray(a)?a:[]).map(e=>this.nSQL.indexTypes[n](e)):this.nSQL.indexTypes[n](a),s},{})}_showTables(){Object.keys(this.nSQL.getDB(this.databaseID)._tables).forEach((e,t)=>{this.progress({table:e,id:this.nSQL.getDB(this.databaseID)._tableIds[e]},t)}),this.complete()}_describe(e="table"){if("string"!=typeof this.query.table)return this.query.state="error",void this.error({error:"Can't call describe on that!",query:this.query});if(!this.nSQL.getDB(this.databaseID)._tables[this.query.table])return this.query.state="error",void this.error({error:`Table ${this.query.table} not found!`,query:this.query});switch(e){case"table":this.nSQL.getDB(this.databaseID)._tables[this.query.table].columns.forEach((e,t)=>{this.progress(i.assign(e),t)});break;case"idx":Object.keys(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes).forEach((e,t)=>{const s=this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes[e];this.progress(i.assign(s),t)})}this.complete()}_combineRows(e){return Object.keys(e).reduce((t,s)=>{const r=e[s];return r?(Object.keys(r).forEach(e=>{t[s+"."+e]=r[e]}),t):t},{})}_streamAS(e,t){const s=(this.query.distinct||[]).map(e=>({isFn:!1,value:e})),r=(this._selectArgs||[]).concat(s);if(r.length){let s={};return r.forEach(r=>{r.isFn?s[r.as||r.value]=t?e[r.as||r.value]:i.execFunction(this.query,r.value,e,{}).result:s[r.as||r.value]=i.deepGet(r.value,e)}),s}return this.query.join?this._combineRows(e):e}quickSort(e,t){if(e.length<2)return e;const s=e=>t.sort.reduce((t,s,r)=>{const a=s.fn?i.execFunction(this.query,s.fn,e,{result:void 0}).result:i.deepGet(s.path,e);return t.push({v:a,d:String(s.dir).toUpperCase()}),t},[]),r=(e,t)=>{let s=0,r=0;for(;r<e.length;)s||e[r].v===t[r].v||(s=(e[r].v>t[r].v?1:-1)*("DESC"===e[r].d?-1:1)),r++;return s},a=s(e[Math.floor(Math.random()*e.length)]);let n=[],o=[],h=[];for(let t of e){const e=r(s(t),a);e>0?h.push(t):e<0?n.push(t):o.push(t)}return this.quickSort(n,t).concat(o).concat(this.quickSort(h,t))}_orderByRows(e,t){return this._sortObj(e,t,this._orderBy)}_sortObj(e,t,s){return s.sort.reduce((s,r)=>{const a=r.fn?i.execFunction(this.query,r.fn,e,{result:void 0}).result:i.deepGet(r.path,e),n=r.fn?i.execFunction(this.query,r.fn,t,{result:void 0}).result:i.deepGet(r.path,t);return a===n?0:s||(a>n?1:-1)*("DESC"===r.dir?-1:1)},0)}_tableID(){return[0,1].map(()=>{let e=i.random16Bits().toString(16);for(;e.length<4;)e="0"+e;return e}).join("-")}_createTable(e,s,r,n,o){const h=this.nSQL.getDB(this.databaseID)._tableIds[e.name]||this._tableID();let l=this.query.table;s||-1===Object.keys(this.nSQL.getDB(this.databaseID)._tables).indexOf(e.name)||(s=!0,l=e.name),new Promise((t,s)=>{let r=!1;const i=e.name;e._internal||0!==i.indexOf("_")&&null===i.match(/\s/g)&&null===i.match(/[\(\)\]\[\.]/g)?(Object.keys(e.model).forEach(t=>{const i=t.replace(/\s+/g,"-").split(":");1===i.length&&i.push("any"),i[0]&&null===i[0].match(/[\(\)\]\[\.]/g)&&0!==i[0].indexOf("_")||(r=!0,s({error:`Invalid Data Model at ${e.name+"."+t}! https://docs.nanosql.io/setup/data-models`,query:this.query}))}),r||t()):s({error:`Invalid Table Name ${e.name}! https://docs.nanosql.io/setup/data-models`,query:this.query})}).then(()=>new Promise((t,s)=>{this.nSQL.doFilter(this.databaseID,"configTable",{res:e,query:this.query},t,s)})).then(e=>{const t=(e,s)=>{let r={};if("string"==typeof e){let t=!1;const i=-1!==e.indexOf("[]"),a=e.replace(/\[\]/gim,"");if(0===s&&i)throw new Error("Can't use array types as table definition.");if(r=Object.keys(this.nSQL.getDB(this.databaseID).config.types||{}).reduce((e,s)=>s===a[1]?(t=!0,(this.nSQL.getDB(this.databaseID).config.types||{})[s]):e,{}),!1===t){if(0===s)throw new Error(`Type ${e} not found!`);return}}else r=e;return Object.keys(e).reduce((r,i)=>{return 0===(i.split(":")[1]||"any").indexOf("geo")?r[i]={default:{lat:0,lon:0},model:{"lat:float":{max:90,min:-90},"lon:float":{max:180,min:-180}}}:e[i].model?r[i]=Object.assign({},e[i],{model:t(e[i].model,s+1)}):r[i]=e[i],r},{})},s=e=>Object.keys(e).filter(e=>"*"!==e).map(t=>({key:t.split(":")[0],type:t.split(":")[1]||"any",ai:e[t].ai,pk:e[t].pk,default:e[t].default,immutable:e[t].immutalbe||!1,notNull:e[t].notNull,max:e[t].max,min:e[t].min,model:e[t].model?s(e[t].model):void 0}));let r="";const n=t(e.res.model,0),o=e=>"string"==typeof e?"":Object.keys(e).reduce((t,s)=>e[s]&&e[s].pk?s.split(":")[1]:!t.length&&e[s].model?o(e[s].model):t,"");let l=e.res.indexes||{},d=!1;const c=(e,t)=>{if("string"==typeof t)return[];let s=!1;return Object.keys(t).reduce((r,i)=>t[i]&&t[i].pk?(s=!0,t[i].ai&&(d=!0),r.push(i.split(":")[0]),r):!s&&t[i].model?c(e.concat([i.split(":")[0]]),t[i].model):r,e)},u=e.res.primaryKey?e.res.primaryKey.split(":")[1]:o(e.res.model);let p={id:h,name:e.res.name,rowLocks:{},count:0,mode:e.res.mode?a.resolveMode(e.res.mode):void 0,model:n,columns:s(n),filter:e.res.filter,select:e.res.select,actions:e.res.actions||[],views:e.res.views||[],queries:(e.res.queries||[]).reduce((e,t)=>(e[t.name]=t,e),{}),indexes:Object.keys(l).map(e=>{const t=(e.split(":")[1]||"string").replace(/\[\]/gim,"");return{id:i.resolvePath(e.split(":")[0]).join("."),type:"date"===t?"int":t,isArray:-1!==(e.split(":")[1]||"string").indexOf("[]"),path:i.resolvePath(e.split(":")[0]),props:l[e],isDate:"date"===t}}).reduce((e,t)=>{return-1===Object.keys(this.nSQL.indexTypes).indexOf(t.type)?(r=`Index "${t.id}" does not have a valid type!`,e):(-1!==t.type.indexOf("geo")?(e[t.id+".lon"]={id:t.id+".lon",type:"float",isArray:!1,path:t.path.concat(["lon"]),props:{offset:180},isDate:!1},e[t.id+".lat"]={id:t.id+".lat",type:"float",isArray:!1,path:t.path.concat(["lat"]),props:{offset:90},isDate:!1}):e[t.id]=t,e)},{}),pkType:u,pkCol:e.res.primaryKey?i.resolvePath(e.res.primaryKey.split(":")[0]):c([],e.res.model),isPkNum:-1!==["number","int","float","date"].indexOf(u),ai:d};return 0===p.pkCol.length&&(p.pkCol=["_id"],p.pkType="uuid",p.model["_id:uuid"]={pk:!0},p.columns=s(t(p.model,0))),r&&r.length?Promise.reject(r):new Promise((e,t)=>{this.nSQL.doFilter(this.databaseID,"configTableSystem",{res:p,query:this.query},t=>{e(t.res)},t)})}).then(e=>{const t=this.nSQL.getDB(this.databaseID)._tables[this.query.table]&&this.nSQL.getDB(this.databaseID)._tables[this.query.table].mode;return e.mode||t?new Promise((r,i)=>{if(s&&e.mode===t)r(e);else{const s=()=>{e.mode?e.mode.connect(this.nSQL.getDB(this.databaseID).state.id,()=>{r(e)},i):r(e)};t?t.disconnect(()=>{s()},i):s()}}):Promise.resolve(e)}).then(e=>"_util"===l?Promise.resolve(e):new Promise((t,r)=>{s?t(e):this.nSQL.triggerQuery(this.databaseID,Object.assign({},i.buildQuery(this.databaseID,this.nSQL,"_util","select"),{where:["key","=","total_"+e.id]}),t=>{t.value&&(e.count=t.value)},()=>{t(e)},r)})).then(e=>{const a=s?Object.keys(this.nSQL.getDB(this.databaseID)._tables[l].indexes):[],n=Object.keys(e.indexes),o=n.filter(e=>-1===a.indexOf(e));let h=[e.name].concat(o);return r(e,0),i.chainAsync(h,(r,o,h,l)=>{if(0===o){const t={name:r,conf:e};if(this.nSQL.getDB(this.databaseID)._tableIds[t.name]=e.id,s){const e=a.filter(e=>-1===n.indexOf(e));i.allAsync(e,(e,t,s,a)=>{i.adapterFilters(this.databaseID,this.nSQL,this.query).deleteIndex(r,e,()=>{s(null)},a)}).then(()=>{this.nSQL.getDB(this.databaseID)._tables[t.name]=t.conf,h(null)}).catch(l)}else i.adapterFilters(this.databaseID,this.nSQL,this.query).createTable(t.name,t.conf,()=>{this.nSQL.getDB(this.databaseID)._tables[t.name]=t.conf,h(null)},l)}else{const s=e.indexes[r];t.secondaryIndexQueue[this.nSQL.getDB(this.databaseID).state.id+s.id]=new i._nanoSQLQueue,i.adapterFilters(this.databaseID,this.nSQL,this.query).createIndex(e.name,s.id,s.type,()=>{h(null)},l)}})}).then(()=>(this.nSQL._rebuildFKs(),"_util"===l?Promise.resolve():this.nSQL._saveTableIds(this.databaseID||""))).then(()=>{n()}).catch(o)}_dropTable(e,t,s){new Promise((t,s)=>{this.nSQL.getDB(this.databaseID)._fkRels[e]&&this.nSQL.getDB(this.databaseID)._fkRels[e].length?i.allAsync(this.nSQL.getDB(this.databaseID)._fkRels[e],(e,t,s,a)=>{switch(e.onDelete){case r.InanoSQLFKActions.RESTRICT:let t=0;i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKeys(e.childTable,e.childIndex,"offset",0,1,!1,(e,s)=>{t++},()=>{t>0?a("Foreign key restraint error, can't drop!"):s()},a);break;case r.InanoSQLFKActions.CASCADE:let n=[];i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKeys(e.childTable,e.childIndex,"all",0,0,!1,(e,t)=>{n.push(e)},()=>{this.nSQL.triggerQuery(this.databaseID,Object.assign({},i.buildQuery(this.databaseID,this.nSQL,e.childTable,"delete"),{where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",n]}),i.noop,s,a)},a);break;case r.InanoSQLFKActions.SET_NULL:let o=[];i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKeys(e.childTable,e.childIndex,"all",0,0,!1,(e,t)=>{o.push(e)},()=>{this.nSQL.triggerQuery(this.databaseID,Object.assign({},i.buildQuery(this.databaseID,this.nSQL,e.childTable,"upsert"),{actionArgs:{[e.childPath.join(".")]:null},where:[e.childPath.join("."),e.childIsArray?"INCLUDES":"IN",n]}),i.noop,s,a)},a);break;default:s()}}).then(t).catch(s):t()}).then(()=>{let s=[];return Object.keys(this.nSQL.getDB(this.databaseID)._tables[e].indexes).forEach(e=>{s.push(e)}),s.push(e),i.chainAsync(s,(t,r,a,n)=>{r===s.length-1?i.adapterFilters(this.databaseID,this.nSQL,this.query).dropTable(t,()=>{delete this.nSQL.getDB(this.databaseID)._tables[t],delete this.nSQL.getDB(this.databaseID)._tableIds[t],this.nSQL._saveTableIds(this.databaseID||"").then(()=>{a(t)}).catch(n)},n):i.adapterFilters(this.databaseID,this.nSQL,this.query).deleteIndex(e,t,a,n)}).then(()=>{this.nSQL.getDB(this.databaseID)._tables[e].count=0,this.nSQL.saveCount(this.databaseID||"",e),t()})}).catch(s)}_onError(e){this.query.state="error",this.error(e)}_resolveFastWhere(e,t,s,r,a){if(t.index&&t.parsedFn)return void this.nSQL.functions[t.parsedFn.name].queryIndex(this.query,t,e,r,a,this._onError);const n="_pk_"===t.index,o=this.nSQL.getDB(this.databaseID)._tables[this.query.table].pkCol;let h=0;const l=new i._nanoSQLQueue((t,s,a,l)=>{t?n?(r(e?i.deepGet(o,t):t,0),a()):e?(r(t,h),h++,a()):i.adapterFilters(this.databaseID,this.nSQL,this.query).read(this.query.table,t,e=>{e&&r(e,h),h++,a()},this.error):a()},this._onError,a);if(t.indexArray)switch(t.comp){case"INCLUDES LIKE":i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value.replace(/\%/gim,"")+" ",t.value.replace(/\%/gim,"")+"~",s,e=>{l.newItem(e)},()=>{l.finished()},this._onError);break;case"INCLUDES":i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKey(this.query.table,t.index,t.value,e=>{l.newItem(e)},()=>{l.finished()},this.error);break;case"INTERSECT ALL":case"INTERSECT":let e={},r=0;i.allAsync(t.value||[],(s,a,n)=>{i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKey(this.query.table,t.index,s,t=>{r=a+1,t&&(e[t]=(e[t]||0)+1)},()=>{n(null)},this.error)}).then(()=>{("INTERSECT"===t.comp?Object.keys(e):Object.keys(e).filter(t=>e[t]===r)).forEach(e=>{l.newItem(e)}),l.finished()})}else switch(t.comp){case"=":e&&n?(r(t.value,0),a()):n?i.adapterFilters(this.databaseID,this.nSQL,this.query).read(this.query.table,t.value,e=>{l.newItem(e),l.finished()},this.error):i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKey(this.query.table,t.index,t.value,e=>{l.newItem(e)},()=>{l.finished()},this.error);break;case"LIKE":n?i.adapterFilters(this.databaseID,this.nSQL,this.query).readMulti(this.query.table,"range",t.value.replace(/\%/gim,"")+"0",t.value.replace(/\%/gim,"")+"Z",s,(e,t)=>{l.newItem(e)},()=>{l.finished()},this._onError):i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value.replace(/\%/gim,"")+" ",t.value.replace(/\%/gim,"")+"~",s,e=>{l.newItem(e)},()=>{l.finished()},this._onError);break;case"BETWEEN":n?i.adapterFilters(this.databaseID,this.nSQL,this.query).readMulti(this.query.table,"range",t.value[0],t.value[1],s,(e,t)=>{l.newItem(e)},()=>{l.finished()},this._onError):i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKeys(this.query.table,t.index,"range",t.value[0],t.value[1],s,e=>{l.newItem(e)},()=>{l.finished()},this._onError);break;case"IN":const o=s?t.value.sort((e,t)=>e<t?1:-1):t.value.sort((e,t)=>e>t?1:-1);e&&n?(o.forEach((e,t)=>r(e,t)),a()):i.allAsync(o,(e,s,r)=>{n?i.adapterFilters(this.databaseID,this.nSQL,this.query).read(this.query.table,e,e=>{l.newItem(e),r()},this.error):i.adapterFilters(this.databaseID,this.nSQL,this.query).readIndexKey(this.query.table,t.index,e,e=>{l.newItem(e)},()=>{r()},this.error)}).then(()=>{l.finished()})}}_fastQuery(e,t){if(this._whereArgs.fastWhere)if(1===this._whereArgs.fastWhere.length){const s=this._whereArgs.fastWhere[0],r=this._pkOrderBy&&"DESC"===this._orderBy.sort[0].dir;this._resolveFastWhere(!1,s,r,(t,s)=>{e(t,s)},t)}else{let s={},r=0;i.chainAsync(this._whereArgs.fastWhere,(e,t,i)=>{if(t%2==1)return void i();r=t;this._resolveFastWhere(!0,e,!1,e=>{s[e]=(s[e]||0)+1},i)}).then(()=>{let i=[];Object.keys(s).forEach(e=>{s[e]===r&&i.push(e)}),this._resolveFastWhere(!1,{index:"_pk_",col:this.nSQL.getDB(this.databaseID)._tables[this.query.table].pkCol.join("."),comp:"IN",value:i,type:this.nSQL.getDB(this.databaseID)._tables[this.query.table].pkType},!1,e,t)})}}_getRecords(e,t,s){const a=s=>{let i=0;for(;i<s.length;)this._whereArgs.type!==r.IWhereType.none?this._whereArgs.whereFn?this._whereArgs.whereFn(s[i],i)&&e(s[i],i):this._where(s[i],this._whereArgs.slowWhere)&&e(s[i],i):e(s[i],i),i++;t()};if("string"==typeof this.query.table)switch(this._whereArgs.type){case r.IWhereType.fast:this._fastQuery((t,s)=>{e(i.mutateRowTypes(this.databaseID,t,this.query.table,this.nSQL),s)},t);break;case r.IWhereType.medium:this._fastQuery((t,s)=>{this._where(t,this._whereArgs.slowWhere)&&e(i.mutateRowTypes(this.databaseID,t,this.query.table,this.nSQL),s)},t);break;case r.IWhereType.slow:case r.IWhereType.none:case r.IWhereType.fn:"select"===this.query.action&&this.query.databaseID&&this.nSQL.getDB(this.query.databaseID)&&this.nSQL.getDB(this.query.databaseID).config.warnOnSlowQuery&&console.warn("Slow Query: Use secondary indexes or primary keys to perform SELECT.  Avoid full table scans!",this.query);const s=this._pkOrderBy&&"DESC"===this._orderBy.sort[0].dir;(!this.query.orderBy||!0===this._pkOrderBy)&&this._whereArgs.type===r.IWhereType.none&&void 0===this.query.groupBy&&void 0!==this.query.limit&&void 0!==this.query.offset?(this._didRangeAlready=!0,i.adapterFilters(this.databaseID,this.nSQL,this.query).readMulti(this.query.table,"offset",this.query.offset,this.query.limit,s,(t,s)=>{e(i.mutateRowTypes(this.databaseID,t,this.query.table,this.nSQL),s)},()=>{t()},this._onError)):i.adapterFilters(this.databaseID,this.nSQL,this.query).readMulti(this.query.table,"all",void 0,void 0,s,(t,s)=>{this._whereArgs.type===r.IWhereType.slow?this._where(t,this._whereArgs.slowWhere)&&e(i.mutateRowTypes(this.databaseID,t,this.query.table,this.nSQL),s):this._whereArgs.type===r.IWhereType.fn&&this._whereArgs.whereFn?this._whereArgs.whereFn(t,s)&&e(i.mutateRowTypes(this.databaseID,t,this.query.table,this.nSQL),s):e(i.mutateRowTypes(this.databaseID,t,this.query.table,this.nSQL),s)},()=>{t()},this._onError)}else"function"==typeof this.query.table?this._getTable(this.query.tableAS||i.fastID(),this.query.where,this.query.table,e=>{a(e.rows)}):Array.isArray(this.query.table)?a(this.query.table):this.query.table&&s("Can't get selected table!")}_rebuildIndexes(e,t,s){const a=this.query.table;if(this.nSQL.getDB(this.databaseID)._tables[a])if(this._whereArgs=this.query.where?this._parseWhere(this.query.where):{type:r.IWhereType.none},this.query.where){const r=new i._nanoSQLQueue((t,s,r,i)=>{this._removeRowAndIndexes(this.nSQL.getDB(this.databaseID)._tables[a],t,()=>{this._newRow(t,r,i),e(t,s)},i)},s,()=>{t()});this._getRecords(e=>{r.newItem(e)},()=>{r.finished()},s)}else{const r=Object.keys(this.nSQL.getDB(this.databaseID)._tables[a].indexes);i.allAsync(r,(e,t,s,r)=>{i.adapterFilters(this.databaseID,this.nSQL,this.query).deleteIndex(a,e,()=>{i.adapterFilters(this.databaseID,this.nSQL,this.query).createIndex(a,e,this.nSQL.getDB(this.databaseID)._tables[a].indexes[e].type,()=>{s(null)},r)},r)}).then(()=>{const r=new i._nanoSQLQueue((t,s,r,n)=>{const o=this.nSQL.getDB(this.databaseID)._tables[a],h=this._getIndexValues(o.indexes,t),l=i.deepGet(o.pkCol,t);i.allAsync(Object.keys(h),(e,t,s,r)=>{const n=h[e];if(o.indexes[e].isArray){const t=h[e]||[];i.allAsync(t,(t,s,i)=>{this._updateIndex(this.query.table,e,t,l,!0,()=>{i(null)},r)}).then(()=>{s()}).catch(r)}else this._updateIndex(a,e,n,l,!0,()=>{s()},r)}).then(()=>{e(t,s),r()}).catch(n)},s,()=>{t()});this._getRecords(e=>{r.newItem(e)},()=>{r.finished()},s)}).catch(s)}else s(new Error(`Table ${a} not found for rebuilding indexes!`))}_where(e,t){if(t.length>1){let s="AND",r=!0,i=0;for(;i<t.length;){const a=t[i];if(i%2==1)s=a;else{let t=!1;t=Array.isArray(a)?this._where(e,a):this._compare(a,e),r=0===i?t:"AND"===s?r&&t:r||t}i++}return r}return this._compare(t[0],e)}_processLIKE(e,t){if(!o.likeCache[t]){let e="";const s=t.split("").length-1;o.likeCache[t]=new RegExp(t.split("").map((t,r)=>"\\"===e?(e=t,t):(e=t,"%"===t?".*":"_"===t?".":0===r?"^"+t:r===s?t+"$":t)).join(""),"gmi")}return"string"!=typeof e?"number"==typeof e?null!==String(e).match(o.likeCache[t]):null!==JSON.stringify(e).match(o.likeCache[t]):null!==e.match(o.likeCache[t])}_getColValue(e,t){const s=e.fnString?i.execFunction(this.query,e.fnString,t,{result:void 0}).result:i.deepGet(e.col,t);return"date"===e.type?Array.isArray(s)?s.map(e=>i.maybeDate(e)):i.maybeDate(s):s}_compare(e,t){const s=this._getColValue(e,t),r=e.value,a=e.comp;if("NULL"===r||"NOT NULL"===r){const e=-1!==[void 0,null,""].indexOf(s),t="="===a||"LIKE"===a;switch(r){case"NULL":return t?e:!e;case"NOT NULL":return t?!e:e}}if(-1!==["IN","NOT IN","BETWEEN","INTERSECT","INTERSECT ALL","NOT INTERSECT"].indexOf(a)&&!Array.isArray(r))return this.query.state="error",this.error(`WHERE "${a}" comparison requires an array value!`),!1;switch(a){case"=":return i.objectsEqual(r,s);case"!=":return!i.objectsEqual(r,s);case">":return s>r;case"<":return s<r;case"<=":return s<=r;case">=":return s>=r;case"IN":return-1!==r.indexOf(s);case"NOT IN":return-1===r.indexOf(s);case"REGEXP":case"REGEX":return null!==(s||"").match(r);case"LIKE":return this._processLIKE(s||"",r);case"NOT LIKE":return!this._processLIKE(s||"",r);case"BETWEEN":return r[0]<=s&&r[1]>=s;case"NOT BETWEEN":return r[0]>=s||r[1]<=s;case"INCLUDES":return-1!==(s||[]).indexOf(r);case"INCLUDES LIKE":return(s||[]).filter(e=>this._processLIKE(e,r)).length>0;case"NOT INCLUDES":return-1===(s||[]).indexOf(r);case"INTERSECT":return(s||[]).filter(e=>r.indexOf(e)>-1).length>0;case"INTERSECT ALL":return(s||[]).filter(e=>r.indexOf(e)>-1).length===r.length;case"NOT INTERSECT":return 0===(s||[]).filter(e=>r.indexOf(e)>-1).length;default:return!1}}_parseSort(e,t){const s=(e&&e.length?i.hash(JSON.stringify(e)):"")+("string"==typeof this.query.table?this.nSQL.getDB(this.databaseID).state.cacheId:"");if(!s)return{sort:[],index:""};if(o._sortMemoized[s])return o._sortMemoized[s];let r=!1;const a=e.map(e=>e.split(" ").map(e=>e.trim())).reduce((e,t)=>{const s=-1!==t[0].indexOf("(");return s&&(r=!0),e.push({path:s?[]:i.resolvePath(t[0]),fn:s?t[0]:void 0,dir:(t[1]||"asc").toUpperCase()}),e},[]);let n="";if(t&&!1===r&&1===a.length){const e="string"==typeof this.query.table?this.nSQL.getDB(this.databaseID)._tables[this.query.table].pkCol:[];if(a[0].path[0].length&&i.objectsEqual(a[0].path,e))n="_pk_";else{const e=Object.keys(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes);let t=e.length;for(;t--&&!n;)i.objectsEqual(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes[e[t]],a[0].path)&&(n=this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes[e[t]].id)}}return o._sortMemoized[s]={sort:a,index:n},o._sortMemoized[s]}_parseSelect(){const e=(this.query.actionArgs&&this.query.actionArgs.length?JSON.stringify(this.query.actionArgs):"")+("string"==typeof this.query.table?this.nSQL.getDB(this.databaseID).state.cacheId:"");this._orderBy=this._parseSort(this.query.orderBy||[],"string"==typeof this.query.table),this._groupBy=this._parseSort(this.query.groupBy||[],!1),e?o._selectArgsMemoized[e]?(this._hasAggrFn=o._selectArgsMemoized[e].hasAggrFn,this._selectArgs=o._selectArgsMemoized[e].args,this._hasFn=o._selectArgsMemoized[e].hasFn):((this.query.actionArgs||[]).forEach(e=>{const t=e.split(/\s+as\s+/i).map(e=>e.trim());if(-1!==t[0].indexOf("(")){const e=t[0].split("(")[0].trim().toUpperCase();this._selectArgs.push({isFn:!0,value:t[0],as:t[1],args:void 0}),this.nSQL.functions[e]?(this._hasFn=!0,"A"===this.nSQL.functions[e].type&&(this._hasAggrFn=!0)):(this.query.state="error",this.error(`Function "${e}" not found!`))}else this._selectArgs.push({isFn:!1,value:t[0],as:t[1]})}),"error"!==this.query.state&&(o._selectArgsMemoized[e]={hasAggrFn:this._hasAggrFn,hasFn:this._hasFn,args:this._selectArgs})):this._selectArgs=[];let t=!1;this._whereArgs.type===r.IWhereType.none?(t="_pk_"===this._orderBy.index)&&(this._pkOrderBy=!0):(t=!!(this._orderBy.index.length&&this._whereArgs.fastWhere&&i.objectsEqual(this._whereArgs.fastWhere[0].col,this._orderBy.sort[0].path)))&&(this._idxOrderBy=!0),(this._orderBy.sort.length&&!t||this._groupBy.sort.length||this._hasAggrFn)&&(this._stream=!1)}_parseWhere(e,t){const s=e||[],a=JSON.stringify(s,(e,t)=>t&&t.constructor&&"RegExp"===t.constructor.name?t.toString():t)+(t?"0":"1")+("string"==typeof this.query.table?this.nSQL.getDB(this.databaseID).state.cacheId:"");if(o._whereMemoized[a])return o._whereMemoized[a];if("function"==typeof s)return{type:r.IWhereType.fn,whereFn:s};if(!s.length)return o._whereMemoized[a]={type:r.IWhereType.none},o._whereMemoized[a];const n="string"==typeof this.query.table?Object.keys(this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes).map(e=>this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes[e]):[],h="string"==typeof this.query.table?this.nSQL.getDB(this.databaseID)._tables[this.query.table].pkCol:[],l="string"==typeof this.query.table?this.nSQL.getDB(this.databaseID)._tables[this.query.table].pkType:"",d=(e,s)=>{const r=!t&&0===s;return e.reduce((e,t,a)=>{if(a%2==1)return"string"!=typeof t?(this.query.state="error",this.error("Malformed WHERE statement!"),e):(e.push(t),e);if(!Array.isArray(t))return this.query.state="error",this.error("Malformed WHERE statement!"),e;if(Array.isArray(t[0]))e.push(d(t,s+1));else if(-1!==t[0].indexOf("(")){const s=t[0].split("(")[1].replace(")","").split(",").map(e=>e.trim()).filter(e=>e),a=t[0].split("(")[0].trim().toUpperCase();let n=!1;if(!this.nSQL.functions[a])return this.query.state="error",this.error(`Function "${a}" not found!`),e;if(r&&this.nSQL.functions[a]&&this.nSQL.functions[a].checkIndex){const r=this.nSQL.functions[a].checkIndex(this.query,s,t);r&&(this._indexesUsed.push(i.assign(t)),n=!0,e.push(r))}n||e.push({fnString:t[0],parsedFn:{name:a,args:s},comp:t[1],value:t[2]})}else{let s=!1;const a=r?i.resolvePath(t[0]):[];-1!==["=","BETWEEN","IN","LIKE"].indexOf(t[1])&&r&&("LIKE"!==t[1]||t[2].match(/.*\%$/gim))&&(i.objectsEqual(a,h)?"LIKE"===t[1]&&"string"!==l||(s=!0,this._indexesUsed.push(i.assign(t)),e.push({index:"_pk_",col:t[0],comp:t[1],value:t[2],type:l})):n.forEach(r=>{"LIKE"===t[1]&&"string"!==r.type||!1===s&&i.objectsEqual(r.path,a)&&!1===r.isArray&&"NOT NULL"!==t[2]&&(s=!0,this._indexesUsed.push(i.assign(t)),e.push({index:r.id,col:t[0],comp:t[1],value:t[2],type:this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes[r.id].type}))})),r&&!s&&-1!==["INCLUDES","INTERSECT","INTERSECT ALL","INCLUDES LIKE"].indexOf(t[1])&&n.forEach(r=>{i.objectsEqual(r.path,a)&&!0===r.isArray&&("INCLUDES LIKE"===t[1]&&"string"!==r.type||(s=!0,this._indexesUsed.push(i.assign(t)),e.push({index:r.id,indexArray:!0,col:t[0],comp:t[1],value:t[2],type:this.nSQL.getDB(this.databaseID)._tables[this.query.table].indexes[r.id].type})))});const o=(e,t)=>{const s=(e,r)=>{const i=r.filter(s=>s.key===t[e])[0];return i?t[e+1]?i.model?s(e+1,i.model):"":i.type:""};return s(0,e)},d="string"==typeof this.query.table?o(this.nSQL.getDB(this.databaseID)._tables[this.query.table].columns,i.resolvePath(t[0])):"";s||e.push({col:t[0],comp:t[1],value:"date"===d?Array.isArray(t[2])?t[2].map(e=>i.maybeDate(e)):i.maybeDate(t[2]):t[2],type:d})}return e},[])};let c=d("string"==typeof s[0]?[s]:s,0),u=!0,p=0,y=-1;for(;p<c.length&&u;)p%2==1?"AND"!==c[p]?u=!1:y=p:Array.isArray(c[p])||!c[p].index?u=!1:y=p,p++;if(y%2==0&&y++,-1===y||"AND"!==c[y]&&c[y])o._whereMemoized[a]={type:r.IWhereType.slow,slowWhere:c};else{const e=c.slice(y+1);o._whereMemoized[a]={type:e.length?r.IWhereType.medium:r.IWhereType.fast,slowWhere:e,fastWhere:c.slice(0,y)}}return o._whereMemoized[a]}}o._whereMemoized={},o._sortMemoized={},o._selectArgsMemoized={},o.likeCache={},t._nanoSQLQuery=o},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(1),i=s(0),a=s(2);t.SQLiteAbstract=(e,t)=>{let s=[],r={};const a=e=>{if(-1===s.indexOf(e))throw Error("No table "+e+" found!");return`"${e}"`},n={createAI:(t,s)=>{e(!0,'CREATE TABLE IF NOT EXISTS "_ai" (id TEXT PRIMARY KEY UNIQUE, inc BIGINT)',[],i.noop,t,s)},createTable:(t,a,n,o,h)=>{s.push(t),r[t]=a,e(!0,`CREATE TABLE IF NOT EXISTS "${t}" (id ${a.isPkNum?"REAL":"TEXT"} PRIMARY KEY UNIQUE, data TEXT)`,[],i.noop,()=>{if(a.ai){let s=[];e(!1,'SELECT "inc" FROM "_ai" WHERE id = ?',[t],e=>{s.push(e)},()=>{s.length?(n[t]=parseInt(s[0].inc),o()):(n[t]=0,e(!0,'INSERT into "_ai" (id, inc) VALUES (?, ?)',[t,0],i.noop,o,h))},h)}else o()},h)},dropTable:(t,r,n)=>{e(!0,`DROP TABLE IF EXISTS ${a(t)}`,[],i.noop,()=>{e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[0,t],i.noop,()=>{s.splice(s.indexOf(t),1),r()},n)},n)},write:(t,s,r,n,o,h,l,d,c)=>{if(void 0===(n=n||i.generateID(t,l[r]+1)))return void c(new Error("Can't add a row without a primary key!"));h&&(l[r]=Math.max(n,l[r])),i.deepSet(s,o,n);const u=JSON.stringify(o),p=()=>{h&&n>=l[r]?e(!0,'UPDATE "_ai" SET inc = ? WHERE id = ?',[l[r],r],i.noop,()=>{d(n)},c):d(n)};let y=[];e(!1,`SELECT id FROM ${a(r)} WHERE id = ?`,[n],e=>{y.push(e)},()=>{y.length?e(!0,`UPDATE ${a(r)} SET data = ? WHERE id = ?`,[u,n],i.noop,p,c):e(!0,`INSERT INTO ${a(r)} (id, data) VALUES (?, ?)`,[n,u],i.noop,p,c)},c)},batch:(t,s,a,o)=>{e(!0,"BEGIN TRANSACTION",[],i.noop,()=>{i.allAsync(s,(e,s,a,o)=>{switch(e.type){case"put":n.write(r[t].pkType,r[t].pkCol,t,i.deepGet(r[t].pkCol,e.data),e.data,r[t].ai,{},a,o);break;case"del":n.remove(t,e.data,a,o)}}).then(t=>{e(!0,"END TRANSACTION",[],i.noop,()=>{a(t)},o)}).catch(o)},o)},read:(t,s,r,i)=>{let n=[];e(!1,`SELECT data FROM ${a(t)} WHERE id = ?`,[s],e=>{n.push(e)},()=>{n.length?r(JSON.parse(n[0].data)):r(void 0)},i)},remove:(t,s,r,n)=>{e(!0,`DELETE FROM ${a(t)} WHERE id = ?`,[s],i.noop,()=>{r()},n)},getIndex:(t,s,r)=>{let i=[];e(!1,`SELECT id FROM ${a(t)} ORDER BY id`,[],e=>{i.push(e.id)},()=>{s(i)},r)},getNumberOfRecords:(t,s,r)=>{let i=[];e(!1,`SELECT COUNT(*) FROM ${a(t)}`,[],e=>{i.push(e)},()=>{s(i[0]["COUNT(*)"])},r)},readMulti:(t,s,r,i,n,o,h,l)=>{let d=`SELECT data FROM ${a(t)}`;"range"===s&&(d+=" WHERE id BETWEEN ? AND ?");let c=d+=n?" ORDER BY id DESC":" ORDER BY id";if("offset"===s){c+=` LIMIT ${i} OFFSET ${n?r+1:r}`}e(!1,c,"range"===s?[r,i]:[],(e,t)=>{o(JSON.parse(e.data),t)},()=>{h()},l)}};return n};t.WebSQL=class extends a.nanoSQLMemoryIndex{constructor(e,s){super(!1,!1),this.plugin={name:"WebSQL Adapter",version:r.VERSION},this._size=1e3*(e||0)*1e3,this._ai={},this._query=this._query.bind(this),this._tableConfigs={},this._sqlite=t.SQLiteAbstract(this._query,s||500)}connect(e,t,s){this._id=e;try{this._db=window.openDatabase(this._id,this.nSQL.dbs[e]?String(this.nSQL.getDB(e).config.version||"1.0"):"1.0",this._id,i.isAndroid?5e6:this._size)}catch(e){s(e)}i.setFast(()=>{this._sqlite.createAI(t,s)})}createTable(e,t,s,r){this._tableConfigs[e]=t,this._sqlite.createTable(e,t,this._ai,s,r)}_query(e,t,s,r,i,a){const n=e=>{e.executeSql(t,s,(e,t)=>{for(let e=0;e<t.rows.length;e++)r(t.rows.item(e),e);i()},(e,t)=>(a(t),!1))};e?this._db.transaction(n):this._db.readTransaction(n)}dropTable(e,t,s){this._sqlite.dropTable(e,t,s)}disconnect(e,t){e()}write(e,t,s,r,i){this._sqlite.write(this._tableConfigs[e].pkType,this._tableConfigs[e].pkCol,e,t,s,this._tableConfigs[e].ai,this._ai,r,i)}read(e,t,s,r){this._sqlite.read(e,t,s,r)}delete(e,t,s,r){this._sqlite.remove(e,t,s,r)}batch(e,t,s,r){this._sqlite.batch(e,t,s,r)}readMulti(e,t,s,r,i,a,n,o){this._sqlite.readMulti(e,t,s,r,i,a,n,o)}getTableIndex(e,t,s){this._sqlite.getIndex(e,t,s)}getTableIndexLength(e,t,s){this._sqlite.getNumberOfRecords(e,t,s)}}},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(1),i=s(0),a=s(2);t.IndexedDB=class extends a.nanoSQLMemoryIndex{constructor(e){super(!1,!1),this.version=e,this.plugin={name:"IndexedDB Adapter",version:r.VERSION},this._db={},this._ai={},this._tableConfigs={}}connect(e,t,s){this._id=e,t()}createTable(e,t,s,r){let a=1;this._tableConfigs[e]=t;const n=i.hash(JSON.stringify(t.columns));this.version?a=this.version:(a=parseInt(localStorage.getItem(this._id+"_"+e+"_idb_version")||"1"),(localStorage.getItem(this._id+"_"+e+"_idb_hash")||n)!==n&&a++,localStorage.setItem(this._id+"_"+e+"_idb_version",String(a)),localStorage.setItem(this._id+"_"+e+"_idb_hash",n));const o=indexedDB.open(this._id+"_"+e,a);this._ai[e]=parseInt(localStorage.getItem(this._id+"_"+e+"_idb_ai")||"0"),o.onerror=r,o.onupgradeneeded=s=>{this._db[e]=s.target.result,this._db[e].objectStoreNames.contains(e)||this._db[e].createObjectStore(e,{keyPath:t.pkCol.join(".")})},o.onsuccess=t=>{this._db[e]=t.target.result,s()}}dropTable(e,t,s){const r=this._db[e].transaction(e,"readwrite");r.onerror=s;const i=r.objectStore(e).clear();i.onerror=s,i.onsuccess=()=>{this._db[e].close(),delete this._db[e],localStorage.removeItem(this._id+"_"+e+"_idb_version"),localStorage.removeItem(this._id+"_"+e+"_idb_hash"),localStorage.removeItem(this._id+"_"+e+"_idb_ai"),t()}}disconnect(e,t){i.allAsync(Object.keys(this._db),(e,t,s,r)=>{this._db[e].close(),i.setFast(()=>{s()})}).then(e).catch(t)}store(e,t,s,r){const i=this._db[e].transaction(e,t);i.onabort=r,i.onerror=r,s(i,i.objectStore(e))}batch(e,t,s,r){this.store(e,"readwrite",(e,i)=>{e.onerror=r;let a=0;for(;a<t.length;){const e=t[a];"put"===e.type?i.put(e.data):i.delete(e.data),a++}e.oncomplete=()=>s([])},r)}write(e,t,s,r,a){void 0===t&&(t=i.generateID(this._tableConfigs[e].pkType,this._ai[e]+1)),void 0!==t?(this._ai[e]=Math.max(t,this._ai[e]),this._tableConfigs[e].ai&&(this._ai[e]=i.cast(this._id,"int",Math.max(this._ai[e]||0,t)),localStorage.setItem(this._id+"_"+e+"_idb_ai",String(this._ai[e]))),i.deepSet(this._tableConfigs[e].pkCol,s,t),this.store(e,"readwrite",(e,i)=>{try{i.put(s).onsuccess=()=>{r(t)}}catch(e){a(e)}},a)):a(new Error("Can't add a row without a primary key!"))}read(e,t,s,r){this.store(e,"readonly",(e,r)=>{const i=r.get(t);i.onerror=e=>{s(void 0)},i.onsuccess=()=>{s(i.result)}},r)}delete(e,t,s,r){this.store(e,"readwrite",(e,i)=>{const a=i.delete(t);a.onerror=r,a.onsuccess=e=>{s()}},r)}readMulti(e,t,s,r,i,a,n,o){let h=0;const l="offset"===t?s:0,d=l+r;let c=!0;this.store(e,"readonly",(e,u)=>{if(u.getAll){const e=u.getAll("range"!==t?void 0:IDBKeyRange.bound(s,r,!1,!1),"offset"!==t||i?void 0:r+s);e.onsuccess=e=>{const o=i?e.target.result.reverse():e.target.result;if("offset"===t){const e=i?1:0;o.slice(s+e,s+r+e).forEach(a)}else o.forEach(a);n()},e.onerror=o}else u.openCursor("range"!==t?void 0:IDBKeyRange.bound(s,r,!1,!1),i?"prev":"next").onsuccess=e=>{const r=e.target.result;if(r){if("offset"===t){if(c){const e=i?l+1:l;return r.advance(e),h=e,void(c=!1)}(i?d>=h:d>h)&&a(r.value,h-s)}else a(r.value,h);h++,r.continue()}else n()}},o)}getTableIndex(e,t,s){let r=[];this.store(e,"readonly",(a,n)=>{if(n.getAllKeys){const e=n.getAllKeys();e.onsuccess=e=>{t(e.target.result)},e.onerror=s}else{const a=n.openCursor();a.onsuccess=s=>{const a=s.target.result;a?(r.push(i.deepGet(this._tableConfigs[e].pkCol,a.value)),a.continue()):t(r)},a.onerror=s}},s)}getTableIndexLength(e,t,s){this.store(e,"readonly",(r,i)=>{const a=r.objectStore(e).count();a.onsuccess=()=>{t(a.result)},a.onerror=s},s)}}},function(e,t,s){Object.defineProperty(t,"__esModule",{value:!0});const r=s(0),i=s(4);var a;t._nanoSQLQueryBuilder=class{constructor(e,t,s,i,a,n){this.databaseID=e,this._db=t,this._AV=n||"",this._query="string"==typeof i?Object.assign({},r.buildQuery(e,t,s,i),{comments:[],state:"pending",action:i,actionArgs:a,result:[]}):Object.assign({},i(t),{state:"pending",result:[]})}where(e){return this._query.where=e,this}orderBy(e){return Array.isArray(e)?this._query.orderBy=e:this._query.orderBy=Object.keys(e).map(t=>`${t} ${String(e[t]).toUpperCase()}`),this}distinct(e){return this._query.distinct=e,this}groupBy(e){return Array.isArray(e)?this._query.groupBy=e:this._query.groupBy=Object.keys(e).map(t=>`${t} ${String(e[t]).toUpperCase()}`),this}having(e){return this._query.having=e,this}join(e){const t="Join commands requires table and type arguments!";return Array.isArray(e)?e.forEach(e=>{e.with.table&&e.type||(this._error=t)}):e.with.table&&e.type||(this._error=t),this._query.join=e,this}limit(e){return this._query.limit=e,this}updateImmutable(e){return this._query.updateImmutable=e,this}comment(e){return this._query.comments.push(e),this}tag(e){return this._query.tags.push(e),this}extend(e,...t){return this._query.extend.push({scope:e,args:t}),this}union(e,t){return this._query.union={queries:e,type:t?"all":"distinct"},this}offset(e){return this._query.offset=e,this}emit(){return this._query}ttl(e=60,t){if("upsert"!==this._query.action)throw new Error("nSQL: Can only do ttl on upsert queries!");return this._query.ttl=e,this._query.ttlCols=t||[],this}graph(e){return this._query.graph=e,this}from(e){return"string"==typeof e||Array.isArray(e)?this._query.table=e:(this._query.table=e.table,this._query.tableAS=e.as),this}into(e){return this._query.table=e,this}on(e){return this._query.table=e,this}toCSV(e){return this.exec().then(t=>Promise.resolve(this._db.JSONtoCSV(t,e)))}copyTo(e,t){return this._query.copyTo={table:e,mutate:t||(e=>e)},this}exec(e){return new Promise((t,s)=>{let r=[];this.stream(e=>{e&&r.push(e)},()=>{t(r)},s,e)})}listen(e){return new n(this.databaseID,this._query,e&&e.debounce,e&&e.unique,e&&e.compareFn)}stream(e,t,s,i){if(this._query.returnEvent=i,this._db.dbs[this.databaseID]&&this._db.getDB(this.databaseID).state.exportQueryObj)e(this._query),t&&t();else{const i=this._query.copyTo?new r._nanoSQLQueue((t,s,i,a)=>{this._query.parent.triggerQuery(this.databaseID,Object.assign({},r.buildQuery(this.databaseID,this._query.parent,this._query.copyTo&&this._query.copyTo.table||"","upsert"),{actionArgs:this._query.copyTo&&this._query.copyTo.mutate(t)}),r.noop,()=>{e(t),i()},a)},s,()=>{t&&t()}):void 0;this._db.triggerQuery(this.databaseID,this._query,t=>{i?i.newItem(t):e(t)},()=>{i?i.finished():t&&t()},s||r.noop)}}cache(e,t,s){const i=r.fastID();let a=[],n=!1,o=0;const h=s||{pageSize:0,onPage:r.noop};this.stream(e=>{a.push(e),h.pageSize&&h.onPage&&a.length%h.pageSize==0&&(n=!0,h.onPage(o,a.slice(a.length-h.pageSize)),o++,h.doNotCache&&(a=[]))},()=>{h.pageSize&&h.onPage&&(!n||h.doNotCache?h.onPage(0,a.slice()):h.onPage(o,a.slice(o*h.pageSize))),h.doNotCache?(a=[],e("",0)):(this._db.getDB(this.databaseID)._queryCache[i]=a,e(i,a.length))},t)}},function(e){e[e.stream=0]="stream",e[e.exec=1]="exec"}(a||(a={}));class n{constructor(e,t,s=500,a=!1,n=i){if(this.databaseID=e,this.query=t,this.debounce=s,this.unique=a,this.compareFn=n,this._listenTables=[],this._active=!0,this.trigger=this.trigger.bind(this),this._doQuery=this._doQuery.bind(this),this._throttleTrigger=this._doQuery.bind(this),this._cbs={stream:[r.noop,r.noop,r.noop,!1],exec:[r.noop,!1]},"string"!=typeof t.table)throw new Error("Can't listen on dynamic tables!");if("select"!==t.action)throw new Error("Can't listen to this kind of query!");if(this._listenTables.push(t.table),t.join){const e=Array.isArray(t.join)?t.join:[t.join];this._listenTables.concat(this._getTables(e))}if(t.graph){const e=Array.isArray(t.graph)?t.graph:[t.graph];this._listenTables.concat(this._getTables(e))}this._listenTables=this._listenTables.filter((e,t,s)=>s.indexOf(e)===t),this._throttleTrigger=r.throttle(this,this._doQuery,s),this._listenTables.forEach(e=>{t.parent.on("change",this._throttleTrigger,e)})}_getTables(e){let t=[];return e.forEach(e=>{e.with&&e.with.table&&"string"==typeof e.with.table&&t.push(e.with.table);const s=e.graph;if(s){const e=Array.isArray(s)?s:[s];t.concat(this._getTables(e))}}),t}_doQuery(){if(this._active&&void 0!==this._mode)switch(this._mode){case a.stream:this.query.returnEvent=this._cbs.stream[3],this.query.parent.triggerQuery(this.databaseID,this.query,this._cbs.stream[0],this._cbs.stream[1],this._cbs.stream[2]);break;case a.exec:this.query.returnEvent=this._cbs.exec[1];let e=[];this.query.parent.triggerQuery(this.databaseID,this.query,t=>{e.push(t)},()=>{if(this.unique){let t=!1;(t=!this._oldValues||(this._oldValues.length!==e.length||!this.compareFn(this._oldValues,e)))&&(this._oldValues=e,this._cbs.exec[0](r.assign(e)))}else this._cbs.exec[0](e)},e=>{this._cbs.exec[0]([],e)})}}_maybeError(){if(void 0!==this._mode)throw new Error("Listen can't have multiple exports!")}trigger(){this._throttleTrigger()}stream(e,t,s,r){if(this.unique)throw new Error("Can't use unique with stream listener!");this._maybeError(),this._mode=a.stream,this._cbs.stream=[e,t,s,r||!1],this._doQuery()}exec(e,t){this._maybeError(),this._mode=a.exec,this._cbs.exec=[e,t||!1],this._doQuery()}unsubscribe(){this._active=!1,this._listenTables.forEach(e=>{this.query.parent.off("change",this._throttleTrigger,e)})}}}])});